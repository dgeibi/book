<!--?xml version="1.0" encoding="UTF-8" standalone="no"?--><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>2.&#xA0;&#x6CE8;&#x91CA;</title><link rel="stylesheet" href="styles.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.73.2"><link rel="start" href="index.html" title="Linux C&#x7F16;&#x7A0B;&#x4E00;&#x7AD9;&#x5F0F;&#x5B66;&#x4E60;"><link rel="up" href="ch09.html" title="&#x7B2C;&#xA0;9&#xA0;&#x7AE0;&#xA0;&#x7F16;&#x7801;&#x98CE;&#x683C;"><link rel="prev" href="ch09s01.html" title="1.&#xA0;&#x7F29;&#x8FDB;&#x548C;&#x7A7A;&#x767D;"><link rel="next" href="ch09s03.html" title="3.&#xA0;&#x6807;&#x8BC6;&#x7B26;&#x547D;&#x540D;"><meta name="viewport" content="width=device-width, initial-scale=1"></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tbody><tr><th colspan="3" align="center">2.&#xA0;&#x6CE8;&#x91CA;</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch09s01.html">&#x4E0A;&#x4E00;&#x9875;</a>&#xA0;</td><th width="60%" align="center">&#x7B2C;&#xA0;9&#xA0;&#x7AE0;&#xA0;&#x7F16;&#x7801;&#x98CE;&#x683C;</th><td width="20%" align="right">&#xA0;<a accesskey="n" href="ch09s03.html">&#x4E0B;&#x4E00;&#x9875;</a></td></tr></tbody></table><hr></div><div class="sect1" lang="zh-cn" xml:lang="zh-cn"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id2738090"></a>2.&#xA0;&#x6CE8;&#x91CA;</h2></div></div></div><p>&#x5355;&#x884C;&#x6CE8;&#x91CA;&#x5E94;&#x91C7;&#x7528;<code class="literal">/*&#x2423;comment&#x2423;*/</code>&#x7684;&#x5F62;&#x5F0F;&#xFF0C;&#x7528;&#x7A7A;&#x683C;&#x628A;&#x754C;&#x5B9A;&#x7B26;&#x548C;&#x6587;&#x5B57;&#x5206;&#x5F00;&#x3002;&#x591A;&#x884C;&#x6CE8;&#x91CA;&#x6700;&#x5E38;&#x89C1;&#x7684;&#x662F;&#x8FD9;&#x79CD;&#x5F62;&#x5F0F;&#xFF1A;</p><pre class="programlisting">/*
&#x2423;*&#x2423;Multi-line
&#x2423;*&#x2423;comment
&#x2423;*/</pre><p>&#x4E5F;&#x6709;&#x66F4;&#x82B1;&#x54E8;&#x7684;&#x5F62;&#x5F0F;&#xFF1A;</p><pre class="programlisting">/*************\
* Multi-line  *
* comment     *
\*************/</pre><p>&#x4F7F;&#x7528;&#x6CE8;&#x91CA;&#x7684;&#x573A;&#x5408;&#x4E3B;&#x8981;&#x6709;&#x4EE5;&#x4E0B;&#x51E0;&#x79CD;&#x3002;</p><p>1&#x3001;&#x6574;&#x4E2A;&#x6E90;&#x6587;&#x4EF6;&#x7684;&#x9876;&#x90E8;&#x6CE8;&#x91CA;&#x3002;&#x8BF4;&#x660E;&#x6B64;&#x6A21;&#x5757;&#x7684;&#x76F8;&#x5173;&#x4FE1;&#x606F;&#xFF0C;&#x4F8B;&#x5982;&#x6587;&#x4EF6;&#x540D;&#x3001;&#x4F5C;&#x8005;&#x548C;&#x7248;&#x672C;&#x5386;&#x53F2;&#x7B49;&#xFF0C;&#x9876;&#x5934;&#x5199;&#x4E0D;&#x7F29;&#x8FDB;&#x3002;&#x4F8B;&#x5982;&#x5185;&#x6838;&#x6E90;&#x4EE3;&#x7801;&#x76EE;&#x5F55;&#x4E0B;&#x7684;<code class="literal">kernel/sched.c</code>&#x6587;&#x4EF6;&#x7684;&#x5F00;&#x5934;&#xFF1A;</p><pre class="programlisting">/*
 *  kernel/sched.c
 *
 *  Kernel scheduler and related syscalls
 *
 *  Copyright (C) 1991-2002  Linus Torvalds
 *
 *  1996-12-23  Modified by Dave Grothe to fix bugs in semaphores and
 *              make semaphores SMP safe
 *  1998-11-19  Implemented schedule_timeout() and related stuff
 *              by Andrea Arcangeli
 *  2002-01-04  New ultra-scalable O(1) scheduler by Ingo Molnar:
 *              hybrid priority-list and round-robin design with
 *              an array-switch method of distributing timeslices
 *              and per-CPU runqueues.  Cleanups and useful suggestions
 *              by Davide Libenzi, preemptible kernel bits by Robert Love.
 *  2003-09-03  Interactivity tuning by Con Kolivas.
 *  2004-04-02  Scheduler domains code by Nick Piggin
 */</pre><p>2&#x3001;&#x51FD;&#x6570;&#x6CE8;&#x91CA;&#x3002;&#x8BF4;&#x660E;&#x6B64;&#x51FD;&#x6570;&#x7684;&#x529F;&#x80FD;&#x3001;&#x53C2;&#x6570;&#x3001;&#x8FD4;&#x56DE;&#x503C;&#x3001;&#x9519;&#x8BEF;&#x7801;&#x7B49;&#xFF0C;&#x5199;&#x5728;&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x4E0A;&#x4FA7;&#xFF0C;&#x548C;&#x6B64;&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x4E4B;&#x95F4;&#x4E0D;&#x7559;&#x7A7A;&#x884C;&#xFF0C;&#x9876;&#x5934;&#x5199;&#x4E0D;&#x7F29;&#x8FDB;&#x3002;</p><p>3&#x3001;&#x76F8;&#x5BF9;&#x72EC;&#x7ACB;&#x7684;&#x8BED;&#x53E5;&#x7EC4;&#x6CE8;&#x91CA;&#x3002;&#x5BF9;&#x8FD9;&#x4E00;&#x7EC4;&#x8BED;&#x53E5;&#x505A;&#x7279;&#x522B;&#x8BF4;&#x660E;&#xFF0C;&#x5199;&#x5728;&#x8BED;&#x53E5;&#x7EC4;&#x4E0A;&#x4FA7;&#xFF0C;&#x548C;&#x6B64;&#x8BED;&#x53E5;&#x7EC4;&#x4E4B;&#x95F4;&#x4E0D;&#x7559;&#x7A7A;&#x884C;&#xFF0C;&#x4E0E;&#x5F53;&#x524D;&#x8BED;&#x53E5;&#x7EC4;&#x7684;&#x7F29;&#x8FDB;&#x4E00;&#x81F4;&#x3002;</p><p>4&#x3001;&#x4EE3;&#x7801;&#x884C;&#x53F3;&#x4FA7;&#x7684;&#x7B80;&#x77ED;&#x6CE8;&#x91CA;&#x3002;&#x5BF9;&#x5F53;&#x524D;&#x4EE3;&#x7801;&#x884C;&#x505A;&#x7279;&#x522B;&#x8BF4;&#x660E;&#xFF0C;&#x4E00;&#x822C;&#x4E3A;&#x5355;&#x884C;&#x6CE8;&#x91CA;&#xFF0C;&#x548C;&#x4EE3;&#x7801;&#x4E4B;&#x95F4;&#x81F3;&#x5C11;&#x7528;&#x4E00;&#x4E2A;&#x7A7A;&#x683C;&#x9694;&#x5F00;&#xFF0C;&#x4E00;&#x4E2A;&#x6E90;&#x6587;&#x4EF6;&#x4E2D;&#x6240;&#x6709;&#x7684;&#x53F3;&#x4FA7;&#x6CE8;&#x91CA;&#x6700;&#x597D;&#x80FD;&#x4E0A;&#x4E0B;&#x5BF9;&#x9F50;&#x3002;&#x5C3D;&#x7BA1;<a class="xref" href="ch02s01.html#expr.morehelloworld">&#x4F8B;&#xA0;2.1 &#x201C;&#x5E26;&#x66F4;&#x591A;&#x6CE8;&#x91CA;&#x7684;Hello World&#x201D;</a>&#x8BB2;&#x8FC7;&#x6CE8;&#x91CA;&#x53EF;&#x4EE5;&#x7A7F;&#x63D2;&#x5728;&#x4E00;&#x884C;&#x4EE3;&#x7801;&#x4E2D;&#x95F4;&#xFF0C;&#x4F46;&#x4E0D;&#x5EFA;&#x8BAE;&#x8FD9;&#x4E48;&#x5199;&#x3002;&#x5185;&#x6838;&#x6E90;&#x4EE3;&#x7801;&#x76EE;&#x5F55;&#x4E0B;&#x7684;<code class="literal">lib/radix-tree.c</code>&#x6587;&#x4EF6;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x5305;&#x542B;&#x4E86;&#x4E0A;&#x8FF0;&#x4E09;&#x79CD;&#x6CE8;&#x91CA;&#xFF1A;</p><pre class="programlisting">/**
 *      radix_tree_insert    -    insert into a radix tree
 *      @root:          radix tree root
 *      @index:         index key
 *      @item:          item to insert
 *
 *      Insert an item into the radix tree at position @index.
 */
int radix_tree_insert(struct radix_tree_root *root,
                        unsigned long index, void *item)
{
        struct radix_tree_node *node = NULL, *slot;
        unsigned int height, shift;
        int offset;
        int error;

        /* Make sure the tree is high enough.  */
        if ((!index &amp;&amp; !root-&gt;rnode) ||
                        index &gt; radix_tree_maxindex(root-&gt;height)) {
                error = radix_tree_extend(root, index);
                if (error)
                        return error;
        }

        slot = root-&gt;rnode;
        height = root-&gt;height;
        shift = (height-1) * RADIX_TREE_MAP_SHIFT;

        offset = 0;                     /* uninitialised var warning */
        do {
                if (slot == NULL) {
                        /* Have to add a child node.  */
                        if (!(slot = radix_tree_node_alloc(root)))
                                return -ENOMEM;
                        if (node) {
                                node-&gt;slots[offset] = slot;
                                node-&gt;count++;
                        } else
                                root-&gt;rnode = slot;
                }

                /* Go a level down */
                offset = (index &gt;&gt; shift) &amp; RADIX_TREE_MAP_MASK;
                node = slot;
                slot = node-&gt;slots[offset];
                shift -= RADIX_TREE_MAP_SHIFT;
                height--;
        } while (height &gt; 0);

        if (slot != NULL)
                return -EEXIST;

        BUG_ON(!node);
        node-&gt;count++;
        node-&gt;slots[offset] = item;
        BUG_ON(tag_get(node, 0, offset));
        BUG_ON(tag_get(node, 1, offset));

        return 0;
}</pre><p><a class="xref" href="bi01.html#bibli.codingstyle" title="Linux&#x5185;&#x6838;&#x6E90;&#x4EE3;&#x7801;&#x76EE;&#x5F55;&#x4E0B;&#x7684;Documentation/CodingStyle&#x6587;&#x4EF6;">[<abbr class="abbrev">CodingStyle</abbr>]</a>&#x4E2D;&#x7279;&#x522B;&#x6307;&#x51FA;&#xFF0C;&#x51FD;&#x6570;&#x5185;&#x7684;&#x6CE8;&#x91CA;&#x8981;&#x5C3D;&#x53EF;&#x80FD;&#x5C11;&#x7528;&#x3002;&#x5199;&#x6CE8;&#x91CA;&#x4E3B;&#x8981;&#x662F;&#x4E3A;&#x4E86;&#x8BF4;&#x660E;&#x4F60;&#x7684;&#x4EE3;&#x7801;&#x201C;<span class="quote">&#x80FD;&#x505A;&#x4EC0;&#x4E48;</span>&#x201D;&#xFF08;&#x6BD4;&#x5982;&#x51FD;&#x6570;&#x63A5;&#x53E3;&#x5B9A;&#x4E49;&#xFF09;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x4E3A;&#x4E86;&#x8BF4;&#x660E;&#x201C;<span class="quote">&#x600E;&#x6837;&#x505A;</span>&#x201D;&#xFF0C;&#x53EA;&#x8981;&#x4EE3;&#x7801;&#x5199;&#x5F97;&#x8DB3;&#x591F;&#x6E05;&#x6670;&#xFF0C;&#x201C;<span class="quote">&#x600E;&#x6837;&#x505A;</span>&#x201D;&#x662F;&#x4E00;&#x76EE;&#x4E86;&#x7136;&#x7684;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x9700;&#x8981;&#x7528;&#x6CE8;&#x91CA;&#x624D;&#x80FD;&#x89E3;&#x91CA;&#x6E05;&#x695A;&#xFF0C;&#x90A3;&#x5C31;&#x8868;&#x793A;&#x4F60;&#x7684;&#x4EE3;&#x7801;&#x53EF;&#x8BFB;&#x6027;&#x5F88;&#x5DEE;&#xFF0C;&#x9664;&#x975E;&#x662F;&#x7279;&#x522B;&#x9700;&#x8981;&#x63D0;&#x9192;&#x6CE8;&#x610F;&#x7684;&#x5730;&#x65B9;&#x624D;&#x4F7F;&#x7528;&#x51FD;&#x6570;&#x5185;&#x6CE8;&#x91CA;&#x3002;</p><p>5&#x3001;&#x590D;&#x6742;&#x7684;&#x7ED3;&#x6784;&#x4F53;&#x5B9A;&#x4E49;&#x6BD4;&#x51FD;&#x6570;&#x66F4;&#x9700;&#x8981;&#x6CE8;&#x91CA;&#x3002;&#x4F8B;&#x5982;&#x5185;&#x6838;&#x6E90;&#x4EE3;&#x7801;&#x76EE;&#x5F55;&#x4E0B;&#x7684;<code class="literal">kernel/sched.c</code>&#x6587;&#x4EF6;&#x4E2D;&#x5B9A;&#x4E49;&#x4E86;&#x8FD9;&#x6837;&#x4E00;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;&#xFF1A;</p><pre class="programlisting">/*
 * This is the main, per-CPU runqueue data structure.
 *
 * Locking rule: those places that want to lock multiple runqueues
 * (such as the load balancing or the thread migration code), lock
 * acquire operations must be ordered by ascending &amp;runqueue.
 */
struct runqueue {
        spinlock_t lock;

        /*
         * nr_running and cpu_load should be in the same cacheline because
         * remote CPUs use both these fields when doing load calculation.
         */
        unsigned long nr_running;
#ifdef CONFIG_SMP
        unsigned long cpu_load[3];
#endif
        unsigned long long nr_switches;

        /*
         * This is part of a global counter where only the total sum
         * over all CPUs matters. A task can increase this counter on
         * one CPU and if it got migrated afterwards it may decrease
         * it on another CPU. Always updated under the runqueue lock:
         */
        unsigned long nr_uninterruptible;

        unsigned long expired_timestamp;
        unsigned long long timestamp_last_tick;
        task_t *curr, *idle;
        struct mm_struct *prev_mm;
        prio_array_t *active, *expired, arrays[2];
        int best_expired_prio;
        atomic_t nr_iowait;

#ifdef CONFIG_SMP
        struct sched_domain *sd;

        /* For active balancing */
        int active_balance;
        int push_cpu;

        task_t *migration_thread;
        struct list_head migration_queue;
        int cpu;
#endif

#ifdef CONFIG_SCHEDSTATS
        /* latency stats */
        struct sched_info rq_sched_info;

        /* sys_sched_yield() stats */
        unsigned long yld_exp_empty;
        unsigned long yld_act_empty;
        unsigned long yld_both_empty;
        unsigned long yld_cnt;

        /* schedule() stats */
        unsigned long sched_switch;
        unsigned long sched_cnt;
        unsigned long sched_goidle;

        /* try_to_wake_up() stats */
        unsigned long ttwu_cnt;
        unsigned long ttwu_local;
#endif
};</pre><p>6&#x3001;&#x590D;&#x6742;&#x7684;&#x5B8F;&#x5B9A;&#x4E49;&#x548C;&#x53D8;&#x91CF;&#x58F0;&#x660E;&#x4E5F;&#x9700;&#x8981;&#x6CE8;&#x91CA;&#x3002;&#x4F8B;&#x5982;&#x5185;&#x6838;&#x6E90;&#x4EE3;&#x7801;&#x76EE;&#x5F55;&#x4E0B;&#x7684;<code class="literal">include/linux/jiffies.h</code>&#x6587;&#x4EF6;&#x4E2D;&#x7684;&#x5B9A;&#x4E49;&#xFF1A;</p><pre class="programlisting">/* TICK_USEC_TO_NSEC is the time between ticks in nsec assuming real ACTHZ and  */
/* a value TUSEC for TICK_USEC (can be set bij adjtimex)                */
#define TICK_USEC_TO_NSEC(TUSEC) (SH_DIV (TUSEC * USER_HZ * 1000, ACTHZ, 8))

/* some arch&apos;s have a small-data section that can be accessed register-relative
 * but that can only take up to, say, 4-byte variables. jiffies being part of
 * an 8-byte variable may not be correctly accessed unless we force the issue
 */
#define __jiffy_data  __attribute__((section(&quot;.data&quot;)))

/*
 * The 64-bit value is not volatile - you MUST NOT read it
 * without sampling the sequence number in xtime_lock.
 * get_jiffies_64() will do this for you as appropriate.
 */
extern u64 __jiffy_data jiffies_64;
extern unsigned long volatile __jiffy_data jiffies;</pre></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tbody><tr><td width="40%" align="left"><a accesskey="p" href="ch09s01.html">&#x4E0A;&#x4E00;&#x9875;</a>&#xA0;</td><td width="20%" align="center"><a accesskey="u" href="ch09.html">&#x4E0A;&#x4E00;&#x7EA7;</a></td><td width="40%" align="right">&#xA0;<a accesskey="n" href="ch09s03.html">&#x4E0B;&#x4E00;&#x9875;</a></td></tr><tr><td width="40%" align="left" valign="top">1.&#xA0;&#x7F29;&#x8FDB;&#x548C;&#x7A7A;&#x767D;&#xA0;</td><td width="20%" align="center"><a accesskey="h" href="index.html">&#x8D77;&#x59CB;&#x9875;</a></td><td width="40%" align="right" valign="top">&#xA0;3.&#xA0;&#x6807;&#x8BC6;&#x7B26;&#x547D;&#x540D;</td></tr></tbody></table></div>
</body></html>