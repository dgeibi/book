<!--?xml version="1.0" encoding="UTF-8" standalone="no"?--><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>2.&#xA0;&#x57FA;&#x4E8E;TCP&#x534F;&#x8BAE;&#x7684;&#x7F51;&#x7EDC;&#x7A0B;&#x5E8F;</title><link rel="stylesheet" href="styles.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.73.2"><link rel="start" href="index.html" title="Linux C&#x7F16;&#x7A0B;&#x4E00;&#x7AD9;&#x5F0F;&#x5B66;&#x4E60;"><link rel="up" href="ch37.html" title="&#x7B2C;&#xA0;37&#xA0;&#x7AE0;&#xA0;socket&#x7F16;&#x7A0B;"><link rel="prev" href="ch37s01.html" title="1.&#xA0;&#x9884;&#x5907;&#x77E5;&#x8BC6;"><link rel="next" href="ch37s03.html" title="3.&#xA0;&#x57FA;&#x4E8E;UDP&#x534F;&#x8BAE;&#x7684;&#x7F51;&#x7EDC;&#x7A0B;&#x5E8F;"><meta name="viewport" content="width=device-width, initial-scale=1"></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tbody><tr><th colspan="3" align="center">2.&#xA0;&#x57FA;&#x4E8E;TCP&#x534F;&#x8BAE;&#x7684;&#x7F51;&#x7EDC;&#x7A0B;&#x5E8F;</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch37s01.html">&#x4E0A;&#x4E00;&#x9875;</a>&#xA0;</td><th width="60%" align="center">&#x7B2C;&#xA0;37&#xA0;&#x7AE0;&#xA0;socket&#x7F16;&#x7A0B;</th><td width="20%" align="right">&#xA0;<a accesskey="n" href="ch37s03.html">&#x4E0B;&#x4E00;&#x9875;</a></td></tr></tbody></table><hr></div><div class="sect1" lang="zh-cn" xml:lang="zh-cn"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="id2903028"></a>2.&#xA0;&#x57FA;&#x4E8E;TCP&#x534F;&#x8BAE;&#x7684;&#x7F51;&#x7EDC;&#x7A0B;&#x5E8F;</h2></div></div></div><p>&#x4E0B;&#x56FE;&#x662F;&#x57FA;&#x4E8E;TCP&#x534F;&#x8BAE;&#x7684;&#x5BA2;&#x6237;&#x7AEF;/&#x670D;&#x52A1;&#x5668;&#x7A0B;&#x5E8F;&#x7684;&#x4E00;&#x822C;&#x6D41;&#x7A0B;&#xFF1A;</p><div class="figure"><a id="id2903037"></a><p class="title"><b>&#x56FE;&#xA0;37.2.&#xA0;TCP&#x534F;&#x8BAE;&#x901A;&#x8BAF;&#x6D41;&#x7A0B;</b></p><div class="figure-contents"><div><img src="images/socket.tcpflowchart.png" alt="TCP&#x534F;&#x8BAE;&#x901A;&#x8BAF;&#x6D41;&#x7A0B;"></div></div></div><br class="figure-break"><p>&#x670D;&#x52A1;&#x5668;&#x8C03;&#x7528;socket()&#x3001;bind()&#x3001;listen()&#x5B8C;&#x6210;&#x521D;&#x59CB;&#x5316;&#x540E;&#xFF0C;&#x8C03;&#x7528;accept()&#x963B;&#x585E;&#x7B49;&#x5F85;&#xFF0C;&#x5904;&#x4E8E;&#x76D1;&#x542C;&#x7AEF;&#x53E3;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x8C03;&#x7528;socket()&#x521D;&#x59CB;&#x5316;&#x540E;&#xFF0C;&#x8C03;&#x7528;connect()&#x53D1;&#x51FA;SYN&#x6BB5;&#x5E76;&#x963B;&#x585E;&#x7B49;&#x5F85;&#x670D;&#x52A1;&#x5668;&#x5E94;&#x7B54;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x5E94;&#x7B54;&#x4E00;&#x4E2A;SYN-ACK&#x6BB5;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x6536;&#x5230;&#x540E;&#x4ECE;connect()&#x8FD4;&#x56DE;&#xFF0C;&#x540C;&#x65F6;&#x5E94;&#x7B54;&#x4E00;&#x4E2A;ACK&#x6BB5;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x6536;&#x5230;&#x540E;&#x4ECE;accept()&#x8FD4;&#x56DE;&#x3002;</p><p>&#x6570;&#x636E;&#x4F20;&#x8F93;&#x7684;&#x8FC7;&#x7A0B;&#xFF1A;</p><p>&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x540E;&#xFF0C;TCP&#x534F;&#x8BAE;&#x63D0;&#x4F9B;&#x5168;&#x53CC;&#x5DE5;&#x7684;&#x901A;&#x4FE1;&#x670D;&#x52A1;&#xFF0C;&#x4F46;&#x662F;&#x4E00;&#x822C;&#x7684;&#x5BA2;&#x6237;&#x7AEF;/&#x670D;&#x52A1;&#x5668;&#x7A0B;&#x5E8F;&#x7684;&#x6D41;&#x7A0B;&#x662F;&#x7531;&#x5BA2;&#x6237;&#x7AEF;&#x4E3B;&#x52A8;&#x53D1;&#x8D77;&#x8BF7;&#x6C42;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x88AB;&#x52A8;&#x5904;&#x7406;&#x8BF7;&#x6C42;&#xFF0C;&#x4E00;&#x95EE;&#x4E00;&#x7B54;&#x7684;&#x65B9;&#x5F0F;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x4ECE;accept()&#x8FD4;&#x56DE;&#x540E;&#x7ACB;&#x523B;&#x8C03;&#x7528;read()&#xFF0C;&#x8BFB;socket&#x5C31;&#x50CF;&#x8BFB;&#x7BA1;&#x9053;&#x4E00;&#x6837;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x6570;&#x636E;&#x5230;&#x8FBE;&#x5C31;&#x963B;&#x585E;&#x7B49;&#x5F85;&#xFF0C;&#x8FD9;&#x65F6;&#x5BA2;&#x6237;&#x7AEF;&#x8C03;&#x7528;write()&#x53D1;&#x9001;&#x8BF7;&#x6C42;&#x7ED9;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x6536;&#x5230;&#x540E;&#x4ECE;read()&#x8FD4;&#x56DE;&#xFF0C;&#x5BF9;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8BF7;&#x6C42;&#x8FDB;&#x884C;&#x5904;&#x7406;&#xFF0C;&#x5728;&#x6B64;&#x671F;&#x95F4;&#x5BA2;&#x6237;&#x7AEF;&#x8C03;&#x7528;read()&#x963B;&#x585E;&#x7B49;&#x5F85;&#x670D;&#x52A1;&#x5668;&#x7684;&#x5E94;&#x7B54;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x8C03;&#x7528;write()&#x5C06;&#x5904;&#x7406;&#x7ED3;&#x679C;&#x53D1;&#x56DE;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x518D;&#x6B21;&#x8C03;&#x7528;read()&#x963B;&#x585E;&#x7B49;&#x5F85;&#x4E0B;&#x4E00;&#x6761;&#x8BF7;&#x6C42;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x6536;&#x5230;&#x540E;&#x4ECE;read()&#x8FD4;&#x56DE;&#xFF0C;&#x53D1;&#x9001;&#x4E0B;&#x4E00;&#x6761;&#x8BF7;&#x6C42;&#xFF0C;&#x5982;&#x6B64;&#x5FAA;&#x73AF;&#x4E0B;&#x53BB;&#x3002;</p><p>&#x5982;&#x679C;&#x5BA2;&#x6237;&#x7AEF;&#x6CA1;&#x6709;&#x66F4;&#x591A;&#x7684;&#x8BF7;&#x6C42;&#x4E86;&#xFF0C;&#x5C31;&#x8C03;&#x7528;close()&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#xFF0C;&#x5C31;&#x50CF;&#x5199;&#x7AEF;&#x5173;&#x95ED;&#x7684;&#x7BA1;&#x9053;&#x4E00;&#x6837;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x7684;read()&#x8FD4;&#x56DE;0&#xFF0C;&#x8FD9;&#x6837;&#x670D;&#x52A1;&#x5668;&#x5C31;&#x77E5;&#x9053;&#x5BA2;&#x6237;&#x7AEF;&#x5173;&#x95ED;&#x4E86;&#x8FDE;&#x63A5;&#xFF0C;&#x4E5F;&#x8C03;&#x7528;close()&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#x3002;&#x6CE8;&#x610F;&#xFF0C;&#x4EFB;&#x4F55;&#x4E00;&#x65B9;&#x8C03;&#x7528;close()&#x540E;&#xFF0C;&#x8FDE;&#x63A5;&#x7684;&#x4E24;&#x4E2A;&#x4F20;&#x8F93;&#x65B9;&#x5411;&#x90FD;&#x5173;&#x95ED;&#xFF0C;&#x4E0D;&#x80FD;&#x518D;&#x53D1;&#x9001;&#x6570;&#x636E;&#x4E86;&#x3002;&#x5982;&#x679C;&#x4E00;&#x65B9;&#x8C03;&#x7528;shutdown()&#x5219;&#x8FDE;&#x63A5;&#x5904;&#x4E8E;&#x534A;&#x5173;&#x95ED;&#x72B6;&#x6001;&#xFF0C;&#x4ECD;&#x53EF;&#x63A5;&#x6536;&#x5BF9;&#x65B9;&#x53D1;&#x6765;&#x7684;&#x6570;&#x636E;&#x3002;</p><p>&#x5728;&#x5B66;&#x4E60;socket API&#x65F6;&#x8981;&#x6CE8;&#x610F;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x548C;TCP&#x534F;&#x8BAE;&#x5C42;&#x662F;&#x5982;&#x4F55;&#x4EA4;&#x4E92;&#x7684;&#xFF1A;
*&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8C03;&#x7528;&#x67D0;&#x4E2A;socket&#x51FD;&#x6570;&#x65F6;TCP&#x534F;&#x8BAE;&#x5C42;&#x5B8C;&#x6210;&#x4EC0;&#x4E48;&#x52A8;&#x4F5C;&#xFF0C;&#x6BD4;&#x5982;&#x8C03;&#x7528;connect()&#x4F1A;&#x53D1;&#x51FA;SYN&#x6BB5;
*&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5982;&#x4F55;&#x77E5;&#x9053;TCP&#x534F;&#x8BAE;&#x5C42;&#x7684;&#x72B6;&#x6001;&#x53D8;&#x5316;&#xFF0C;&#x6BD4;&#x5982;&#x4ECE;&#x67D0;&#x4E2A;&#x963B;&#x585E;&#x7684;socket&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x5C31;&#x8868;&#x660E;TCP&#x534F;&#x8BAE;&#x6536;&#x5230;&#x4E86;&#x67D0;&#x4E9B;&#x6BB5;&#xFF0C;&#x518D;&#x6BD4;&#x5982;read()&#x8FD4;&#x56DE;0&#x5C31;&#x8868;&#x660E;&#x6536;&#x5230;&#x4E86;FIN&#x6BB5;</p><div class="sect2" lang="zh-cn" xml:lang="zh-cn"><div class="titlepage"><div><div><h3 class="title"><a id="id2902690"></a>2.1.&#xA0;&#x6700;&#x7B80;&#x5355;&#x7684;TCP&#x7F51;&#x7EDC;&#x7A0B;&#x5E8F;</h3></div></div></div><p>&#x4E0B;&#x9762;&#x901A;&#x8FC7;&#x6700;&#x7B80;&#x5355;&#x7684;&#x5BA2;&#x6237;&#x7AEF;/&#x670D;&#x52A1;&#x5668;&#x7A0B;&#x5E8F;&#x7684;&#x5B9E;&#x4F8B;&#x6765;&#x5B66;&#x4E60;socket API&#x3002;</p><p>server.c&#x7684;&#x4F5C;&#x7528;&#x662F;&#x4ECE;&#x5BA2;&#x6237;&#x7AEF;&#x8BFB;&#x5B57;&#x7B26;&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x6BCF;&#x4E2A;&#x5B57;&#x7B26;&#x8F6C;&#x6362;&#x4E3A;&#x5927;&#x5199;&#x5E76;&#x56DE;&#x9001;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#x3002;</p><pre class="programlisting">/* server.c */
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;netinet/in.h&gt;

#define MAXLINE 80
#define SERV_PORT 8000

int main(void)
{
	struct sockaddr_in servaddr, cliaddr;
	socklen_t cliaddr_len;
	int listenfd, connfd;
	char buf[MAXLINE];
	char str[INET_ADDRSTRLEN];
	int i, n;

	listenfd = socket(AF_INET, SOCK_STREAM, 0);

	bzero(&amp;servaddr, sizeof(servaddr));
	servaddr.sin_family = AF_INET;
	servaddr.sin_addr.s_addr = htonl(INADDR_ANY);
	servaddr.sin_port = htons(SERV_PORT);
    
	bind(listenfd, (struct sockaddr *)&amp;servaddr, sizeof(servaddr));

	listen(listenfd, 20);

	printf(&quot;Accepting connections ...\n&quot;);
	while (1) {
		cliaddr_len = sizeof(cliaddr);
		connfd = accept(listenfd, 
				(struct sockaddr *)&amp;cliaddr, &amp;cliaddr_len);
	  
		n = read(connfd, buf, MAXLINE);
		printf(&quot;received from %s at PORT %d\n&quot;,
		       inet_ntop(AF_INET, &amp;cliaddr.sin_addr, str, sizeof(str)),
		       ntohs(cliaddr.sin_port));
    
		for (i = 0; i &lt; n; i++)
			buf[i] = toupper(buf[i]);
		write(connfd, buf, n);
		close(connfd);
	}
}</pre><p>&#x4E0B;&#x9762;&#x4ECB;&#x7ECD;&#x7A0B;&#x5E8F;&#x4E2D;&#x7528;&#x5230;&#x7684;socket API&#xFF0C;&#x8FD9;&#x4E9B;&#x51FD;&#x6570;&#x90FD;&#x5728;<code class="literal">sys/socket.h</code>&#x4E2D;&#x3002;</p><pre class="programlisting">int socket(int family, int type, int protocol);</pre><p>socket()&#x6253;&#x5F00;&#x4E00;&#x4E2A;&#x7F51;&#x7EDC;&#x901A;&#x8BAF;&#x7AEF;&#x53E3;&#xFF0C;&#x5982;&#x679C;&#x6210;&#x529F;&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x50CF;open()&#x4E00;&#x6837;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#xFF0C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53EF;&#x4EE5;&#x50CF;&#x8BFB;&#x5199;&#x6587;&#x4EF6;&#x4E00;&#x6837;&#x7528;read/write&#x5728;&#x7F51;&#x7EDC;&#x4E0A;&#x6536;&#x53D1;&#x6570;&#x636E;&#xFF0C;&#x5982;&#x679C;socket()&#x8C03;&#x7528;&#x51FA;&#x9519;&#x5219;&#x8FD4;&#x56DE;-1&#x3002;&#x5BF9;&#x4E8E;IPv4&#xFF0C;family&#x53C2;&#x6570;&#x6307;&#x5B9A;&#x4E3A;AF_INET&#x3002;&#x5BF9;&#x4E8E;TCP&#x534F;&#x8BAE;&#xFF0C;type&#x53C2;&#x6570;&#x6307;&#x5B9A;&#x4E3A;SOCK_STREAM&#xFF0C;&#x8868;&#x793A;&#x9762;&#x5411;&#x6D41;&#x7684;&#x4F20;&#x8F93;&#x534F;&#x8BAE;&#x3002;&#x5982;&#x679C;&#x662F;UDP&#x534F;&#x8BAE;&#xFF0C;&#x5219;type&#x53C2;&#x6570;&#x6307;&#x5B9A;&#x4E3A;SOCK_DGRAM&#xFF0C;&#x8868;&#x793A;&#x9762;&#x5411;&#x6570;&#x636E;&#x62A5;&#x7684;&#x4F20;&#x8F93;&#x534F;&#x8BAE;&#x3002;protocol&#x53C2;&#x6570;&#x7684;&#x4ECB;&#x7ECD;&#x4ECE;&#x7565;&#xFF0C;&#x6307;&#x5B9A;&#x4E3A;0&#x5373;&#x53EF;&#x3002;</p><pre class="programlisting">int bind(int sockfd, const struct sockaddr *myaddr, socklen_t addrlen);</pre><p>&#x670D;&#x52A1;&#x5668;&#x7A0B;&#x5E8F;&#x6240;&#x76D1;&#x542C;&#x7684;&#x7F51;&#x7EDC;&#x5730;&#x5740;&#x548C;&#x7AEF;&#x53E3;&#x53F7;&#x901A;&#x5E38;&#x662F;&#x56FA;&#x5B9A;&#x4E0D;&#x53D8;&#x7684;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x7A0B;&#x5E8F;&#x5F97;&#x77E5;&#x670D;&#x52A1;&#x5668;&#x7A0B;&#x5E8F;&#x7684;&#x5730;&#x5740;&#x548C;&#x7AEF;&#x53E3;&#x53F7;&#x540E;&#x5C31;&#x53EF;&#x4EE5;&#x5411;&#x670D;&#x52A1;&#x5668;&#x53D1;&#x8D77;&#x8FDE;&#x63A5;&#xFF0C;&#x56E0;&#x6B64;&#x670D;&#x52A1;&#x5668;&#x9700;&#x8981;&#x8C03;&#x7528;bind&#x7ED1;&#x5B9A;&#x4E00;&#x4E2A;&#x56FA;&#x5B9A;&#x7684;&#x7F51;&#x7EDC;&#x5730;&#x5740;&#x548C;&#x7AEF;&#x53E3;&#x53F7;&#x3002;bind()&#x6210;&#x529F;&#x8FD4;&#x56DE;0&#xFF0C;&#x5931;&#x8D25;&#x8FD4;&#x56DE;-1&#x3002;</p><p>bind()&#x7684;&#x4F5C;&#x7528;&#x662F;&#x5C06;&#x53C2;&#x6570;sockfd&#x548C;myaddr&#x7ED1;&#x5B9A;&#x5728;&#x4E00;&#x8D77;&#xFF0C;&#x4F7F;sockfd&#x8FD9;&#x4E2A;&#x7528;&#x4E8E;&#x7F51;&#x7EDC;&#x901A;&#x8BAF;&#x7684;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#x76D1;&#x542C;myaddr&#x6240;&#x63CF;&#x8FF0;&#x7684;&#x5730;&#x5740;&#x548C;&#x7AEF;&#x53E3;&#x53F7;&#x3002;&#x524D;&#x9762;&#x8BB2;&#x8FC7;&#xFF0C;struct sockaddr *&#x662F;&#x4E00;&#x4E2A;&#x901A;&#x7528;&#x6307;&#x9488;&#x7C7B;&#x578B;&#xFF0C;myaddr&#x53C2;&#x6570;&#x5B9E;&#x9645;&#x4E0A;&#x53EF;&#x4EE5;&#x63A5;&#x53D7;&#x591A;&#x79CD;&#x534F;&#x8BAE;&#x7684;sockaddr&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x800C;&#x5B83;&#x4EEC;&#x7684;&#x957F;&#x5EA6;&#x5404;&#x4E0D;&#x76F8;&#x540C;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x7B2C;&#x4E09;&#x4E2A;&#x53C2;&#x6570;addrlen&#x6307;&#x5B9A;&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x957F;&#x5EA6;&#x3002;&#x6211;&#x4EEC;&#x7684;&#x7A0B;&#x5E8F;&#x4E2D;&#x5BF9;myaddr&#x53C2;&#x6570;&#x662F;&#x8FD9;&#x6837;&#x521D;&#x59CB;&#x5316;&#x7684;&#xFF1A;</p><pre class="programlisting">bzero(&amp;servaddr, sizeof(servaddr));
servaddr.sin_family = AF_INET;
servaddr.sin_addr.s_addr = htonl(INADDR_ANY);
servaddr.sin_port = htons(SERV_PORT);</pre><p>&#x9996;&#x5148;&#x5C06;&#x6574;&#x4E2A;&#x7ED3;&#x6784;&#x4F53;&#x6E05;&#x96F6;&#xFF0C;&#x7136;&#x540E;&#x8BBE;&#x7F6E;&#x5730;&#x5740;&#x7C7B;&#x578B;&#x4E3A;AF_INET&#xFF0C;&#x7F51;&#x7EDC;&#x5730;&#x5740;&#x4E3A;INADDR_ANY&#xFF0C;&#x8FD9;&#x4E2A;&#x5B8F;&#x8868;&#x793A;&#x672C;&#x5730;&#x7684;&#x4EFB;&#x610F;IP&#x5730;&#x5740;&#xFF0C;&#x56E0;&#x4E3A;&#x670D;&#x52A1;&#x5668;&#x53EF;&#x80FD;&#x6709;&#x591A;&#x4E2A;&#x7F51;&#x5361;&#xFF0C;&#x6BCF;&#x4E2A;&#x7F51;&#x5361;&#x4E5F;&#x53EF;&#x80FD;&#x7ED1;&#x5B9A;&#x591A;&#x4E2A;IP&#x5730;&#x5740;&#xFF0C;&#x8FD9;&#x6837;&#x8BBE;&#x7F6E;&#x53EF;&#x4EE5;&#x5728;&#x6240;&#x6709;&#x7684;IP&#x5730;&#x5740;&#x4E0A;&#x76D1;&#x542C;&#xFF0C;&#x76F4;&#x5230;&#x4E0E;&#x67D0;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x5EFA;&#x7ACB;&#x4E86;&#x8FDE;&#x63A5;&#x65F6;&#x624D;&#x786E;&#x5B9A;&#x4E0B;&#x6765;&#x5230;&#x5E95;&#x7528;&#x54EA;&#x4E2A;IP&#x5730;&#x5740;&#xFF0C;&#x7AEF;&#x53E3;&#x53F7;&#x4E3A;SERV_PORT&#xFF0C;&#x6211;&#x4EEC;&#x5B9A;&#x4E49;&#x4E3A;8000&#x3002;</p><pre class="programlisting">int listen(int sockfd, int backlog);</pre><p>&#x5178;&#x578B;&#x7684;&#x670D;&#x52A1;&#x5668;&#x7A0B;&#x5E8F;&#x53EF;&#x4EE5;&#x540C;&#x65F6;&#x670D;&#x52A1;&#x4E8E;&#x591A;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x5F53;&#x6709;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x8D77;&#x8FDE;&#x63A5;&#x65F6;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x8C03;&#x7528;&#x7684;accept()&#x8FD4;&#x56DE;&#x5E76;&#x63A5;&#x53D7;&#x8FD9;&#x4E2A;&#x8FDE;&#x63A5;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x5927;&#x91CF;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x8D77;&#x8FDE;&#x63A5;&#x800C;&#x670D;&#x52A1;&#x5668;&#x6765;&#x4E0D;&#x53CA;&#x5904;&#x7406;&#xFF0C;&#x5C1A;&#x672A;accept&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x5C31;&#x5904;&#x4E8E;&#x8FDE;&#x63A5;&#x7B49;&#x5F85;&#x72B6;&#x6001;&#xFF0C;listen()&#x58F0;&#x660E;sockfd&#x5904;&#x4E8E;&#x76D1;&#x542C;&#x72B6;&#x6001;&#xFF0C;&#x5E76;&#x4E14;&#x6700;&#x591A;&#x5141;&#x8BB8;&#x6709;backlog&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x5904;&#x4E8E;&#x8FDE;&#x63A5;&#x5F85;&#x72B6;&#x6001;&#xFF0C;&#x5982;&#x679C;&#x63A5;&#x6536;&#x5230;&#x66F4;&#x591A;&#x7684;&#x8FDE;&#x63A5;&#x8BF7;&#x6C42;&#x5C31;&#x5FFD;&#x7565;&#x3002;listen()&#x6210;&#x529F;&#x8FD4;&#x56DE;0&#xFF0C;&#x5931;&#x8D25;&#x8FD4;&#x56DE;-1&#x3002;</p><pre class="programlisting">int accept(int sockfd, struct sockaddr *cliaddr, socklen_t *addrlen);</pre><p>&#x4E09;&#x65B9;&#x63E1;&#x624B;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x8C03;&#x7528;accept()&#x63A5;&#x53D7;&#x8FDE;&#x63A5;&#xFF0C;&#x5982;&#x679C;&#x670D;&#x52A1;&#x5668;&#x8C03;&#x7528;accept()&#x65F6;&#x8FD8;&#x6CA1;&#x6709;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8FDE;&#x63A5;&#x8BF7;&#x6C42;&#xFF0C;&#x5C31;&#x963B;&#x585E;&#x7B49;&#x5F85;&#x76F4;&#x5230;&#x6709;&#x5BA2;&#x6237;&#x7AEF;&#x8FDE;&#x63A5;&#x4E0A;&#x6765;&#x3002;cliaddr&#x662F;&#x4E00;&#x4E2A;&#x4F20;&#x51FA;&#x53C2;&#x6570;&#xFF0C;accept()&#x8FD4;&#x56DE;&#x65F6;&#x4F20;&#x51FA;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x5730;&#x5740;&#x548C;&#x7AEF;&#x53E3;&#x53F7;&#x3002;addrlen&#x53C2;&#x6570;&#x662F;&#x4E00;&#x4E2A;&#x4F20;&#x5165;&#x4F20;&#x51FA;&#x53C2;&#x6570;&#xFF08;value-result argument&#xFF09;&#xFF0C;&#x4F20;&#x5165;&#x7684;&#x662F;&#x8C03;&#x7528;&#x8005;&#x63D0;&#x4F9B;&#x7684;&#x7F13;&#x51B2;&#x533A;cliaddr&#x7684;&#x957F;&#x5EA6;&#x4EE5;&#x907F;&#x514D;&#x7F13;&#x51B2;&#x533A;&#x6EA2;&#x51FA;&#x95EE;&#x9898;&#xFF0C;&#x4F20;&#x51FA;&#x7684;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x5730;&#x5740;&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5B9E;&#x9645;&#x957F;&#x5EA6;&#xFF08;&#x6709;&#x53EF;&#x80FD;&#x6CA1;&#x6709;&#x5360;&#x6EE1;&#x8C03;&#x7528;&#x8005;&#x63D0;&#x4F9B;&#x7684;&#x7F13;&#x51B2;&#x533A;&#xFF09;&#x3002;&#x5982;&#x679C;&#x7ED9;cliaddr&#x53C2;&#x6570;&#x4F20;NULL&#xFF0C;&#x8868;&#x793A;&#x4E0D;&#x5173;&#x5FC3;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x5730;&#x5740;&#x3002;</p><p>&#x6211;&#x4EEC;&#x7684;&#x670D;&#x52A1;&#x5668;&#x7A0B;&#x5E8F;&#x7ED3;&#x6784;&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF1A;</p><pre class="programlisting">while (1) {
	cliaddr_len = sizeof(cliaddr);
	connfd = accept(listenfd, 
			(struct sockaddr *)&amp;cliaddr, &amp;cliaddr_len);
	n = read(connfd, buf, MAXLINE);
	...
	close(connfd);
}</pre><p>&#x6574;&#x4E2A;&#x662F;&#x4E00;&#x4E2A;while&#x6B7B;&#x5FAA;&#x73AF;&#xFF0C;&#x6BCF;&#x6B21;&#x5FAA;&#x73AF;&#x5904;&#x7406;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x8FDE;&#x63A5;&#x3002;&#x7531;&#x4E8E;cliaddr_len&#x662F;&#x4F20;&#x5165;&#x4F20;&#x51FA;&#x53C2;&#x6570;&#xFF0C;&#x6BCF;&#x6B21;&#x8C03;&#x7528;accept()&#x4E4B;&#x524D;&#x5E94;&#x8BE5;&#x91CD;&#x65B0;&#x8D4B;&#x521D;&#x503C;&#x3002;accept()&#x7684;&#x53C2;&#x6570;listenfd&#x662F;&#x5148;&#x524D;&#x7684;&#x76D1;&#x542C;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#xFF0C;&#x800C;accept()&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x662F;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;connfd&#xFF0C;&#x4E4B;&#x540E;&#x4E0E;&#x5BA2;&#x6237;&#x7AEF;&#x4E4B;&#x95F4;&#x5C31;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;connfd&#x901A;&#x8BAF;&#xFF0C;&#x6700;&#x540E;&#x5173;&#x95ED;connfd&#x65AD;&#x5F00;&#x8FDE;&#x63A5;&#xFF0C;&#x800C;&#x4E0D;&#x5173;&#x95ED;listenfd&#xFF0C;&#x518D;&#x6B21;&#x56DE;&#x5230;&#x5FAA;&#x73AF;&#x5F00;&#x5934;listenfd&#x4ECD;&#x7136;&#x7528;&#x4F5C;accept&#x7684;&#x53C2;&#x6570;&#x3002;accept()&#x6210;&#x529F;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#xFF0C;&#x51FA;&#x9519;&#x8FD4;&#x56DE;-1&#x3002;</p><p>client.c&#x7684;&#x4F5C;&#x7528;&#x662F;&#x4ECE;&#x547D;&#x4EE4;&#x884C;&#x53C2;&#x6570;&#x4E2D;&#x83B7;&#x5F97;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#x53D1;&#x7ED9;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x7136;&#x540E;&#x63A5;&#x6536;&#x670D;&#x52A1;&#x5668;&#x8FD4;&#x56DE;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x5E76;&#x6253;&#x5370;&#x3002;</p><pre class="programlisting">/* client.c */
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;netinet/in.h&gt;

#define MAXLINE 80
#define SERV_PORT 8000

int main(int argc, char *argv[])
{
	struct sockaddr_in servaddr;
	char buf[MAXLINE];
	int sockfd, n;
	char *str;
    
	if (argc != 2) {
		fputs(&quot;usage: ./client message\n&quot;, stderr);
		exit(1);
	}
	str = argv[1];
    
	sockfd = socket(AF_INET, SOCK_STREAM, 0);

	bzero(&amp;servaddr, sizeof(servaddr));
	servaddr.sin_family = AF_INET;
	inet_pton(AF_INET, &quot;127.0.0.1&quot;, &amp;servaddr.sin_addr);
	servaddr.sin_port = htons(SERV_PORT);
    
	connect(sockfd, (struct sockaddr *)&amp;servaddr, sizeof(servaddr));

	write(sockfd, str, strlen(str));

	n = read(sockfd, buf, MAXLINE);
	printf(&quot;Response from server:\n&quot;);
	write(STDOUT_FILENO, buf, n);

	close(sockfd);
	return 0;
}</pre><p>&#x7531;&#x4E8E;&#x5BA2;&#x6237;&#x7AEF;&#x4E0D;&#x9700;&#x8981;&#x56FA;&#x5B9A;&#x7684;&#x7AEF;&#x53E3;&#x53F7;&#xFF0C;&#x56E0;&#x6B64;&#x4E0D;&#x5FC5;&#x8C03;&#x7528;bind()&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x7AEF;&#x53E3;&#x53F7;&#x7531;&#x5185;&#x6838;&#x81EA;&#x52A8;&#x5206;&#x914D;&#x3002;&#x6CE8;&#x610F;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x4E0D;&#x662F;&#x4E0D;&#x5141;&#x8BB8;&#x8C03;&#x7528;bind()&#xFF0C;&#x53EA;&#x662F;&#x6CA1;&#x6709;&#x5FC5;&#x8981;&#x8C03;&#x7528;bind()&#x56FA;&#x5B9A;&#x4E00;&#x4E2A;&#x7AEF;&#x53E3;&#x53F7;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x4E5F;&#x4E0D;&#x662F;&#x5FC5;&#x987B;&#x8C03;&#x7528;bind()&#xFF0C;&#x4F46;&#x5982;&#x679C;&#x670D;&#x52A1;&#x5668;&#x4E0D;&#x8C03;&#x7528;bind()&#xFF0C;&#x5185;&#x6838;&#x4F1A;&#x81EA;&#x52A8;&#x7ED9;&#x670D;&#x52A1;&#x5668;&#x5206;&#x914D;&#x76D1;&#x542C;&#x7AEF;&#x53E3;&#xFF0C;&#x6BCF;&#x6B21;&#x542F;&#x52A8;&#x670D;&#x52A1;&#x5668;&#x65F6;&#x7AEF;&#x53E3;&#x53F7;&#x90FD;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x8981;&#x8FDE;&#x63A5;&#x670D;&#x52A1;&#x5668;&#x5C31;&#x4F1A;&#x9047;&#x5230;&#x9EBB;&#x70E6;&#x3002;</p><pre class="programlisting">int connect(int sockfd, const struct sockaddr *servaddr, socklen_t addrlen);</pre><p>&#x5BA2;&#x6237;&#x7AEF;&#x9700;&#x8981;&#x8C03;&#x7528;connect()&#x8FDE;&#x63A5;&#x670D;&#x52A1;&#x5668;&#xFF0C;connect&#x548C;bind&#x7684;&#x53C2;&#x6570;&#x5F62;&#x5F0F;&#x4E00;&#x81F4;&#xFF0C;&#x533A;&#x522B;&#x5728;&#x4E8E;bind&#x7684;&#x53C2;&#x6570;&#x662F;&#x81EA;&#x5DF1;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x800C;connect&#x7684;&#x53C2;&#x6570;&#x662F;&#x5BF9;&#x65B9;&#x7684;&#x5730;&#x5740;&#x3002;connect()&#x6210;&#x529F;&#x8FD4;&#x56DE;0&#xFF0C;&#x51FA;&#x9519;&#x8FD4;&#x56DE;-1&#x3002;</p><p>&#x5148;&#x7F16;&#x8BD1;&#x8FD0;&#x884C;&#x670D;&#x52A1;&#x5668;: </p><pre class="screen">$ ./server
 Accepting connections ...</pre><p>&#x7136;&#x540E;&#x5728;&#x53E6;&#x4E00;&#x4E2A;&#x7EC8;&#x7AEF;&#x91CC;&#x7528;netstat&#x547D;&#x4EE4;&#x67E5;&#x770B;&#xFF1A;</p><pre class="screen">$ netstat -apn|grep 8000
 tcp        0      0 0.0.0.0:8000            0.0.0.0:*               LISTEN     8148/server</pre><p>&#x53EF;&#x4EE5;&#x770B;&#x5230;server&#x7A0B;&#x5E8F;&#x76D1;&#x542C;8000&#x7AEF;&#x53E3;&#xFF0C;IP&#x5730;&#x5740;&#x8FD8;&#x6CA1;&#x786E;&#x5B9A;&#x4E0B;&#x6765;&#x3002;&#x73B0;&#x5728;&#x7F16;&#x8BD1;&#x8FD0;&#x884C;&#x5BA2;&#x6237;&#x7AEF;&#xFF1A;</p><pre class="screen">$ ./client abcd
Response from server:
ABCD</pre><p>&#x56DE;&#x5230;server&#x6240;&#x5728;&#x7684;&#x7EC8;&#x7AEF;&#xFF0C;&#x770B;&#x770B;server&#x7684;&#x8F93;&#x51FA;&#xFF1A;</p><pre class="screen">$ ./server
 Accepting connections ...
 received from 127.0.0.1 at PORT 59757</pre><p>&#x53EF;&#x89C1;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x7AEF;&#x53E3;&#x53F7;&#x662F;&#x81EA;&#x52A8;&#x5206;&#x914D;&#x7684;&#x3002;&#x73B0;&#x5728;&#x628A;&#x5BA2;&#x6237;&#x7AEF;&#x6240;&#x8FDE;&#x63A5;&#x7684;&#x670D;&#x52A1;&#x5668;IP&#x6539;&#x4E3A;&#x5176;&#x5B83;&#x4E3B;&#x673A;&#x7684;IP&#xFF0C;&#x8BD5;&#x8BD5;&#x4E24;&#x53F0;&#x4E3B;&#x673A;&#x7684;&#x901A;&#x8BAF;&#x3002;</p><p>&#x518D;&#x505A;&#x4E00;&#x4E2A;&#x5C0F;&#x5B9E;&#x9A8C;&#xFF0C;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x7684;connect()&#x4EE3;&#x7801;&#x4E4B;&#x540E;&#x63D2;&#x4E00;&#x4E2A;while(1);&#x6B7B;&#x5FAA;&#x73AF;&#xFF0C;&#x4F7F;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x90FD;&#x5904;&#x4E8E;&#x8FDE;&#x63A5;&#x4E2D;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x7528;netstat&#x547D;&#x4EE4;&#x67E5;&#x770B;&#xFF1A;</p><pre class="screen">$ ./server &amp;
[1] 8343
$ Accepting connections ...
./client abcd &amp;
[2] 8344
$ netstat -apn|grep 8000
tcp        0      0 0.0.0.0:8000            0.0.0.0:*               LISTEN     8343/server         
tcp        0      0 127.0.0.1:44406         127.0.0.1:8000          ESTABLISHED8344/client         
tcp        0      0 127.0.0.1:8000          127.0.0.1:44406         ESTABLISHED8343/server</pre><p>&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;socket&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;socket pair&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6E90;&#x5730;&#x5740;:&#x6E90;&#x7AEF;&#x53E3;&#x53F7;&#x548C;&#x76EE;&#x7684;&#x5730;&#x5740;:&#x76EE;&#x7684;&#x7AEF;&#x53E3;&#x53F7;&#xFF0C;&#x4E5F;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;TCP&#x8FDE;&#x63A5;&#x3002;</p><div class="table"><a id="id2903589"></a><p class="title"><b>&#x8868;&#xA0;37.1.&#xA0;client&#x548C;server&#x7684;socket&#x72B6;&#x6001;</b></p><div class="table-contents"><table summary="client&#x548C;server&#x7684;socket&#x72B6;&#x6001;" border="1"><colgroup><col><col><col><col></colgroup><thead><tr><th>socket&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;</th><th>&#x6E90;&#x5730;&#x5740;:&#x6E90;&#x7AEF;&#x53E3;&#x53F7;</th><th>&#x76EE;&#x7684;&#x5730;&#x5740;:&#x76EE;&#x7684;&#x7AEF;&#x53E3;&#x53F7;</th><th>&#x72B6;&#x6001;</th></tr></thead><tbody><tr><td>server.c&#x4E2D;&#x7684;listenfd</td><td>0.0.0.0:8000</td><td>0.0.0.0:*</td><td>LISTEN</td></tr><tr><td>server.c&#x4E2D;&#x7684;connfd</td><td>127.0.0.1:8000</td><td>127.0.0.1:44406</td><td>ESTABLISHED</td></tr><tr><td>client.c&#x4E2D;&#x7684;sockfd</td><td>127.0.0.1:44406</td><td>127.0.0.1:8000</td><td>ESTABLISHED</td></tr></tbody></table></div></div><br class="table-break"></div><div class="sect2" lang="zh-cn" xml:lang="zh-cn"><div class="titlepage"><div><div><h3 class="title"><a id="id2903656"></a>2.2.&#xA0;&#x9519;&#x8BEF;&#x5904;&#x7406;&#x4E0E;&#x8BFB;&#x5199;&#x63A7;&#x5236;</h3></div></div></div><p>&#x4E0A;&#x9762;&#x7684;&#x4F8B;&#x5B50;&#x4E0D;&#x4EC5;&#x529F;&#x80FD;&#x7B80;&#x5355;&#xFF0C;&#x800C;&#x4E14;&#x7B80;&#x5355;&#x5230;&#x51E0;&#x4E4E;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x9519;&#x8BEF;&#x5904;&#x7406;&#xFF0C;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#xFF0C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x4E0D;&#x80FD;&#x4FDD;&#x8BC1;&#x6BCF;&#x6B21;&#x90FD;&#x6210;&#x529F;&#xFF0C;&#x5FC5;&#x987B;&#x8FDB;&#x884C;&#x51FA;&#x9519;&#x5904;&#x7406;&#xFF0C;&#x8FD9;&#x6837;&#x4E00;&#x65B9;&#x9762;&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;&#x7A0B;&#x5E8F;&#x903B;&#x8F91;&#x6B63;&#x5E38;&#xFF0C;&#x53E6;&#x4E00;&#x65B9;&#x9762;&#x53EF;&#x4EE5;&#x8FC5;&#x901F;&#x5F97;&#x5230;&#x6545;&#x969C;&#x4FE1;&#x606F;&#x3002;</p><p>&#x4E3A;&#x4F7F;&#x9519;&#x8BEF;&#x5904;&#x7406;&#x7684;&#x4EE3;&#x7801;&#x4E0D;&#x5F71;&#x54CD;&#x4E3B;&#x7A0B;&#x5E8F;&#x7684;&#x53EF;&#x8BFB;&#x6027;&#xFF0C;&#x6211;&#x4EEC;&#x628A;&#x4E0E;socket&#x76F8;&#x5173;&#x7684;&#x4E00;&#x4E9B;&#x7CFB;&#x7EDF;&#x51FD;&#x6570;&#x52A0;&#x4E0A;&#x9519;&#x8BEF;&#x5904;&#x7406;&#x4EE3;&#x7801;&#x5305;&#x88C5;&#x6210;&#x65B0;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x505A;&#x6210;&#x4E00;&#x4E2A;&#x6A21;&#x5757;wrap.c&#xFF1A;</p><pre class="programlisting">#include &lt;stdlib.h&gt;
#include &lt;errno.h&gt;
#include &lt;sys/socket.h&gt;

void perr_exit(const char *s)
{
	perror(s);
	exit(1);
}

int Accept(int fd, struct sockaddr *sa, socklen_t *salenptr)
{
	int n;

again:
	if ( (n = accept(fd, sa, salenptr)) &lt; 0) {
		if ((errno == ECONNABORTED) || (errno == EINTR))
			goto again;
		else
			perr_exit(&quot;accept error&quot;);
	}
	return n;
}

void Bind(int fd, const struct sockaddr *sa, socklen_t salen)
{
	if (bind(fd, sa, salen) &lt; 0)
		perr_exit(&quot;bind error&quot;);
}

void Connect(int fd, const struct sockaddr *sa, socklen_t salen)
{
	if (connect(fd, sa, salen) &lt; 0)
		perr_exit(&quot;connect error&quot;);
}

void Listen(int fd, int backlog)
{
	if (listen(fd, backlog) &lt; 0)
		perr_exit(&quot;listen error&quot;);
}

int Socket(int family, int type, int protocol)
{
	int n;

	if ( (n = socket(family, type, protocol)) &lt; 0)
		perr_exit(&quot;socket error&quot;);
	return n;
}

ssize_t Read(int fd, void *ptr, size_t nbytes)
{
	ssize_t n;

again:
	if ( (n = read(fd, ptr, nbytes)) == -1) {
		if (errno == EINTR)
			goto again;
		else
			return -1;
	}
	return n;
}

ssize_t Write(int fd, const void *ptr, size_t nbytes)
{
	ssize_t n;

again:
	if ( (n = write(fd, ptr, nbytes)) == -1) {
		if (errno == EINTR)
			goto again;
		else
			return -1;
	}
	return n;
}

void Close(int fd)
{
	if (close(fd) == -1)
		perr_exit(&quot;close error&quot;);
}</pre><p>&#x6162;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;accept&#x3001;read&#x548C;write&#x88AB;&#x4FE1;&#x53F7;&#x4E2D;&#x65AD;&#x65F6;&#x5E94;&#x8BE5;&#x91CD;&#x8BD5;&#x3002;connect&#x867D;&#x7136;&#x4E5F;&#x4F1A;&#x963B;&#x585E;&#xFF0C;&#x4F46;&#x662F;&#x88AB;&#x4FE1;&#x53F7;&#x4E2D;&#x65AD;&#x65F6;&#x4E0D;&#x80FD;&#x7ACB;&#x523B;&#x91CD;&#x8BD5;&#x3002;&#x5BF9;&#x4E8E;accept&#xFF0C;&#x5982;&#x679C;errno&#x662F;ECONNABORTED&#xFF0C;&#x4E5F;&#x5E94;&#x8BE5;&#x91CD;&#x8BD5;&#x3002;&#x8BE6;&#x7EC6;&#x89E3;&#x91CA;&#x89C1;&#x53C2;&#x8003;&#x8D44;&#x6599;&#x3002;</p><p>TCP&#x534F;&#x8BAE;&#x662F;&#x9762;&#x5411;&#x6D41;&#x7684;&#xFF0C;read&#x548C;write&#x8C03;&#x7528;&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x5F80;&#x5F80;&#x5C0F;&#x4E8E;&#x53C2;&#x6570;&#x6307;&#x5B9A;&#x7684;&#x5B57;&#x8282;&#x6570;&#x3002;&#x5BF9;&#x4E8E;read&#x8C03;&#x7528;&#xFF0C;&#x5982;&#x679C;&#x63A5;&#x6536;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x6709;20&#x5B57;&#x8282;&#xFF0C;&#x8BF7;&#x6C42;&#x8BFB;100&#x4E2A;&#x5B57;&#x8282;&#xFF0C;&#x5C31;&#x4F1A;&#x8FD4;&#x56DE;20&#x3002;&#x5BF9;&#x4E8E;write&#x8C03;&#x7528;&#xFF0C;&#x5982;&#x679C;&#x8BF7;&#x6C42;&#x5199;100&#x4E2A;&#x5B57;&#x8282;&#xFF0C;&#x800C;&#x53D1;&#x9001;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x53EA;&#x6709;20&#x4E2A;&#x5B57;&#x8282;&#x7684;&#x7A7A;&#x95F2;&#x4F4D;&#x7F6E;&#xFF0C;&#x90A3;&#x4E48;write&#x4F1A;&#x963B;&#x585E;&#xFF0C;&#x76F4;&#x5230;&#x628A;100&#x4E2A;&#x5B57;&#x8282;&#x5168;&#x90E8;&#x4EA4;&#x7ED9;&#x53D1;&#x9001;&#x7F13;&#x51B2;&#x533A;&#x624D;&#x8FD4;&#x56DE;&#xFF0C;&#x4F46;&#x5982;&#x679C;socket&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#x6709;O_NONBLOCK&#x6807;&#x5FD7;&#xFF0C;&#x5219;write&#x4E0D;&#x963B;&#x585E;&#xFF0C;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;20&#x3002;&#x4E3A;&#x907F;&#x514D;&#x8FD9;&#x4E9B;&#x60C5;&#x51B5;&#x5E72;&#x6270;&#x4E3B;&#x7A0B;&#x5E8F;&#x7684;&#x903B;&#x8F91;&#xFF0C;&#x786E;&#x4FDD;&#x8BFB;&#x5199;&#x6211;&#x4EEC;&#x6240;&#x8BF7;&#x6C42;&#x7684;&#x5B57;&#x8282;&#x6570;&#xFF0C;&#x6211;&#x4EEC;&#x5B9E;&#x73B0;&#x4E86;&#x4E24;&#x4E2A;&#x5305;&#x88C5;&#x51FD;&#x6570;readn&#x548C;writen&#xFF0C;&#x4E5F;&#x653E;&#x5728;wrap.c&#x4E2D;&#xFF1A;</p><pre class="programlisting">ssize_t Readn(int fd, void *vptr, size_t n)
{
	size_t  nleft;
	ssize_t nread;
	char   *ptr;

	ptr = vptr;
	nleft = n;
	while (nleft &gt; 0) {
		if ( (nread = read(fd, ptr, nleft)) &lt; 0) {
			if (errno == EINTR)
				nread = 0;
			else
				return -1;
		} else if (nread == 0)
			break;

		nleft -= nread;
		ptr += nread;
	}
	return n - nleft;
}

ssize_t Writen(int fd, const void *vptr, size_t n)
{
	size_t nleft;
	ssize_t nwritten;
	const char *ptr;

	ptr = vptr;
	nleft = n;
	while (nleft &gt; 0) {
		if ( (nwritten = write(fd, ptr, nleft)) &lt;= 0) {
			if (nwritten &lt; 0 &amp;&amp; errno == EINTR)
				nwritten = 0;
			else
				return -1;
		}

		nleft -= nwritten;
		ptr += nwritten;
	}
	return n;
}</pre><p>&#x5982;&#x679C;&#x5E94;&#x7528;&#x5C42;&#x534F;&#x8BAE;&#x7684;&#x5404;&#x5B57;&#x6BB5;&#x957F;&#x5EA6;&#x56FA;&#x5B9A;&#xFF0C;&#x7528;readn&#x6765;&#x8BFB;&#x662F;&#x975E;&#x5E38;&#x65B9;&#x4FBF;&#x7684;&#x3002;&#x4F8B;&#x5982;&#x8BBE;&#x8BA1;&#x4E00;&#x79CD;&#x5BA2;&#x6237;&#x7AEF;&#x4E0A;&#x4F20;&#x6587;&#x4EF6;&#x7684;&#x534F;&#x8BAE;&#xFF0C;&#x89C4;&#x5B9A;&#x524D;12&#x5B57;&#x8282;&#x8868;&#x793A;&#x6587;&#x4EF6;&#x540D;&#xFF0C;&#x8D85;&#x8FC7;12&#x5B57;&#x8282;&#x7684;&#x6587;&#x4EF6;&#x540D;&#x622A;&#x65AD;&#xFF0C;&#x4E0D;&#x8DB3;12&#x5B57;&#x8282;&#x7684;&#x6587;&#x4EF6;&#x540D;&#x7528;&apos;\0&apos;&#x8865;&#x9F50;&#xFF0C;&#x4ECE;&#x7B2C;13&#x5B57;&#x8282;&#x5F00;&#x59CB;&#x662F;&#x6587;&#x4EF6;&#x5185;&#x5BB9;&#xFF0C;&#x4E0A;&#x4F20;&#x5B8C;&#x6240;&#x6709;&#x6587;&#x4EF6;&#x5185;&#x5BB9;&#x540E;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x53EF;&#x4EE5;&#x5148;&#x8C03;&#x7528;readn&#x8BFB;12&#x4E2A;&#x5B57;&#x8282;&#xFF0C;&#x6839;&#x636E;&#x6587;&#x4EF6;&#x540D;&#x521B;&#x5EFA;&#x6587;&#x4EF6;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x4E00;&#x4E2A;&#x5FAA;&#x73AF;&#x4E2D;&#x8C03;&#x7528;read&#x8BFB;&#x6587;&#x4EF6;&#x5185;&#x5BB9;&#x5E76;&#x5B58;&#x76D8;&#xFF0C;&#x5FAA;&#x73AF;&#x7ED3;&#x675F;&#x7684;&#x6761;&#x4EF6;&#x662F;read&#x8FD4;&#x56DE;0&#x3002;</p><p>&#x5B57;&#x6BB5;&#x957F;&#x5EA6;&#x56FA;&#x5B9A;&#x7684;&#x534F;&#x8BAE;&#x5F80;&#x5F80;&#x4E0D;&#x591F;&#x7075;&#x6D3B;&#xFF0C;&#x96BE;&#x4EE5;&#x9002;&#x5E94;&#x65B0;&#x7684;&#x53D8;&#x5316;&#x3002;&#x6BD4;&#x5982;&#xFF0C;&#x4EE5;&#x524D;DOS&#x7684;&#x6587;&#x4EF6;&#x540D;&#x662F;8&#x5B57;&#x8282;&#x4E3B;&#x6587;&#x4EF6;&#x540D;&#x52A0;&#x201C;.&#x201D;&#x52A0;3&#x5B57;&#x8282;&#x6269;&#x5C55;&#x540D;&#xFF0C;&#x4E0D;&#x8D85;&#x8FC7;12&#x5B57;&#x8282;&#xFF0C;&#x4F46;&#x662F;&#x73B0;&#x4EE3;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;&#x6587;&#x4EF6;&#x540D;&#x53EF;&#x4EE5;&#x957F;&#x5F97;&#x591A;&#xFF0C;12&#x5B57;&#x8282;&#x5C31;&#x4E0D;&#x591F;&#x7528;&#x4E86;&#x3002;&#x90A3;&#x4E48;&#x5236;&#x5B9A;&#x4E00;&#x4E2A;&#x65B0;&#x7248;&#x672C;&#x7684;&#x534F;&#x8BAE;&#x89C4;&#x5B9A;&#x6587;&#x4EF6;&#x540D;&#x5B57;&#x6BB5;&#x4E3A;256&#x5B57;&#x8282;&#x600E;&#x4E48;&#x6837;&#xFF1F;&#x8FD9;&#x6837;&#x53C8;&#x9020;&#x6210;&#x5F88;&#x5927;&#x7684;&#x6D6A;&#x8D39;&#xFF0C;&#x56E0;&#x4E3A;&#x5927;&#x591A;&#x6570;&#x6587;&#x4EF6;&#x540D;&#x90FD;&#x5F88;&#x77ED;&#xFF0C;&#x9700;&#x8981;&#x7528;&#x5927;&#x91CF;&#x7684;&apos;\0&apos;&#x8865;&#x9F50;256&#x5B57;&#x8282;&#xFF0C;&#x800C;&#x4E14;&#x65B0;&#x7248;&#x672C;&#x7684;&#x534F;&#x8BAE;&#x548C;&#x8001;&#x7248;&#x672C;&#x7684;&#x7A0B;&#x5E8F;&#x65E0;&#x6CD5;&#x517C;&#x5BB9;&#xFF0C;&#x5982;&#x679C;&#x5DF2;&#x7ECF;&#x6709;&#x5F88;&#x591A;&#x4EBA;&#x5728;&#x7528;&#x8001;&#x7248;&#x672C;&#x7684;&#x7A0B;&#x5E8F;&#x4E86;&#xFF0C;&#x4F1A;&#x9020;&#x6210;&#x9075;&#x5FAA;&#x65B0;&#x534F;&#x8BAE;&#x7684;&#x7A0B;&#x5E8F;&#x4E0E;&#x8001;&#x7248;&#x672C;&#x7A0B;&#x5E8F;&#x7684;&#x4E92;&#x64CD;&#x4F5C;&#x6027;&#xFF08;Interoperability&#xFF09;&#x95EE;&#x9898;&#x3002;&#x5982;&#x679C;&#x65B0;&#x7248;&#x672C;&#x7684;&#x534F;&#x8BAE;&#x8981;&#x6DFB;&#x52A0;&#x65B0;&#x7684;&#x5B57;&#x6BB5;&#xFF0C;&#x6BD4;&#x5982;&#x89C4;&#x5B9A;&#x524D;12&#x5B57;&#x8282;&#x662F;&#x6587;&#x4EF6;&#x540D;&#xFF0C;&#x4ECE;13&#x5230;16&#x5B57;&#x8282;&#x662F;&#x6587;&#x4EF6;&#x7C7B;&#x578B;&#x8BF4;&#x660E;&#xFF0C;&#x4ECE;&#x7B2C;17&#x5B57;&#x8282;&#x5F00;&#x59CB;&#x624D;&#x662F;&#x6587;&#x4EF6;&#x5185;&#x5BB9;&#xFF0C;&#x540C;&#x6837;&#x4F1A;&#x9020;&#x6210;&#x548C;&#x8001;&#x7248;&#x672C;&#x7684;&#x7A0B;&#x5E8F;&#x65E0;&#x6CD5;&#x517C;&#x5BB9;&#x7684;&#x95EE;&#x9898;&#x3002;</p><p>&#x73B0;&#x5728;&#x91CD;&#x65B0;&#x770B;&#x770B;&#x4E0A;&#x4E00;&#x8282;&#x7684;TFTP&#x534F;&#x8BAE;&#x662F;&#x5982;&#x4F55;&#x907F;&#x514D;&#x4E0A;&#x8FF0;&#x95EE;&#x9898;&#x7684;&#xFF1A;TFTP&#x534F;&#x8BAE;&#x7684;&#x5404;&#x5B57;&#x6BB5;&#x662F;&#x53EF;&#x53D8;&#x957F;&#x7684;&#xFF0C;&#x4EE5;&apos;\0&apos;&#x4E3A;&#x5206;&#x9694;&#x7B26;&#xFF0C;&#x6587;&#x4EF6;&#x540D;&#x53EF;&#x4EE5;&#x4EFB;&#x610F;&#x957F;&#xFF0C;&#x518D;&#x770B;blksize&#x7B49;&#x51E0;&#x4E2A;&#x9009;&#x9879;&#x5B57;&#x6BB5;&#xFF0C;TFTP&#x534F;&#x8BAE;&#x5E76;&#x6CA1;&#x6709;&#x89C4;&#x5B9A;&#x4ECE;&#x7B2C;m&#x5B57;&#x8282;&#x5230;&#x7B2C;n&#x5B57;&#x8282;&#x662F;blksize&#x7684;&#x503C;&#xFF0C;&#x800C;&#x662F;&#x628A;&#x9009;&#x9879;&#x7684;&#x63CF;&#x8FF0;&#x4FE1;&#x606F;&#x201C;blksize&#x201D;&#x4E0E;&#x5B83;&#x7684;&#x503C;&#x201C;512&#x201D;&#x4E00;&#x8D77;&#x505A;&#x6210;&#x4E00;&#x4E2A;&#x53EF;&#x53D8;&#x957F;&#x7684;&#x5B57;&#x6BB5;&#xFF0C;&#x8FD9;&#x6837;&#xFF0C;&#x4EE5;&#x540E;&#x6DFB;&#x52A0;&#x65B0;&#x7684;&#x9009;&#x9879;&#x4ECD;&#x7136;&#x53EF;&#x4EE5;&#x548C;&#x8001;&#x7248;&#x672C;&#x7684;&#x7A0B;&#x5E8F;&#x517C;&#x5BB9;&#xFF08;&#x8001;&#x7248;&#x672C;&#x7684;&#x7A0B;&#x5E8F;&#x53EA;&#x8981;&#x5FFD;&#x7565;&#x4E0D;&#x8BA4;&#x8BC6;&#x7684;&#x9009;&#x9879;&#x5C31;&#x884C;&#x4E86;&#xFF09;&#x3002;</p><p>&#x56E0;&#x6B64;&#xFF0C;&#x5E38;&#x89C1;&#x7684;&#x5E94;&#x7528;&#x5C42;&#x534F;&#x8BAE;&#x90FD;&#x662F;&#x5E26;&#x6709;&#x53EF;&#x53D8;&#x957F;&#x5B57;&#x6BB5;&#x7684;&#xFF0C;&#x5B57;&#x6BB5;&#x4E4B;&#x95F4;&#x7684;&#x5206;&#x9694;&#x7B26;&#x7528;&#x6362;&#x884C;&#x7684;&#x6BD4;&#x7528;&apos;\0&apos;&#x7684;&#x66F4;&#x5E38;&#x89C1;&#xFF0C;&#x4F8B;&#x5982;&#x672C;&#x8282;&#x540E;&#x9762;&#x8981;&#x4ECB;&#x7ECD;&#x7684;HTTP&#x534F;&#x8BAE;&#x3002;&#x53EF;&#x53D8;&#x957F;&#x5B57;&#x6BB5;&#x7684;&#x534F;&#x8BAE;&#x7528;readn&#x6765;&#x8BFB;&#x5C31;&#x5F88;&#x4E0D;&#x65B9;&#x4FBF;&#x4E86;&#xFF0C;&#x4E3A;&#x6B64;&#x6211;&#x4EEC;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x7C7B;&#x4F3C;&#x4E8E;fgets&#x7684;readline&#x51FD;&#x6570;&#xFF0C;&#x4E5F;&#x653E;&#x5728;wrap.c&#x4E2D;&#xFF1A;</p><pre class="programlisting">static ssize_t my_read(int fd, char *ptr)
{
	static int read_cnt;
	static char *read_ptr;
	static char read_buf[100];

	if (read_cnt &lt;= 0) {
	again:
		if ( (read_cnt = read(fd, read_buf, sizeof(read_buf))) &lt; 0) {
			if (errno == EINTR)
				goto again;
			return -1;
		} else if (read_cnt == 0)
			return 0;
		read_ptr = read_buf;
	}
	read_cnt--;
	*ptr = *read_ptr++;
	return 1;
}

ssize_t Readline(int fd, void *vptr, size_t maxlen)
{
	ssize_t n, rc;
	char    c, *ptr;

	ptr = vptr;
	for (n = 1; n &lt; maxlen; n++) {
		if ( (rc = my_read(fd, &amp;c)) == 1) {
			*ptr++ = c;
			if (c  == &apos;\n&apos;)
				break;
		} else if (rc == 0) {
			*ptr = 0;
			return n - 1;
		} else
			return -1;
	}
	*ptr  = 0;
	return n;
}</pre><div class="simplesect" lang="zh-cn" xml:lang="zh-cn"><div class="titlepage"><div><div><h4 class="title"><a id="id2903831"></a>&#x4E60;&#x9898;</h4></div></div></div><p>1&#x3001;&#x8BF7;&#x8BFB;&#x8005;&#x81EA;&#x5DF1;&#x5199;&#x51FA;wrap.c&#x7684;&#x5934;&#x6587;&#x4EF6;wrap.h&#xFF0C;&#x540E;&#x9762;&#x7684;&#x7F51;&#x7EDC;&#x7A0B;&#x5E8F;&#x4EE3;&#x7801;&#x90FD;&#x8981;&#x7528;&#x5230;&#x8FD9;&#x4E2A;&#x5934;&#x6587;&#x4EF6;&#x3002;</p><p>2&#x3001;&#x4FEE;&#x6539;server.c&#x548C;client.c&#xFF0C;&#x6DFB;&#x52A0;&#x9519;&#x8BEF;&#x5904;&#x7406;&#x3002;</p></div></div><div class="sect2" lang="zh-cn" xml:lang="zh-cn"><div class="titlepage"><div><div><h3 class="title"><a id="id2903862"></a>2.3.&#xA0;&#x628A;client&#x6539;&#x4E3A;&#x4EA4;&#x4E92;&#x5F0F;&#x8F93;&#x5165;</h3></div></div></div><p>&#x76EE;&#x524D;&#x5B9E;&#x73B0;&#x7684;client&#x6BCF;&#x6B21;&#x8FD0;&#x884C;&#x53EA;&#x80FD;&#x4ECE;&#x547D;&#x4EE4;&#x884C;&#x8BFB;&#x53D6;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#x53D1;&#x7ED9;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x518D;&#x4ECE;&#x670D;&#x52A1;&#x5668;&#x6536;&#x56DE;&#x6765;&#xFF0C;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x628A;&#x5B83;&#x6539;&#x6210;&#x4EA4;&#x4E92;&#x5F0F;&#x7684;&#xFF0C;&#x4E0D;&#x65AD;&#x4ECE;&#x7EC8;&#x7AEF;&#x63A5;&#x53D7;&#x7528;&#x6237;&#x8F93;&#x5165;&#x5E76;&#x548C;server&#x4EA4;&#x4E92;&#x3002; </p><pre class="programlisting">/* client.c */
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;netinet/in.h&gt;
#include &quot;wrap.h&quot;

#define MAXLINE 80
#define SERV_PORT 8000

int main(int argc, char *argv[])
{
	struct sockaddr_in servaddr;
	char buf[MAXLINE];
	int sockfd, n;
    
	sockfd = Socket(AF_INET, SOCK_STREAM, 0);

	bzero(&amp;servaddr, sizeof(servaddr));
	servaddr.sin_family = AF_INET;
	inet_pton(AF_INET, &quot;127.0.0.1&quot;, &amp;servaddr.sin_addr);
	servaddr.sin_port = htons(SERV_PORT);
    
	Connect(sockfd, (struct sockaddr *)&amp;servaddr, sizeof(servaddr));

	while (fgets(buf, MAXLINE, stdin) != NULL) {
		Write(sockfd, buf, strlen(buf));
		n = Read(sockfd, buf, MAXLINE);
		if (n == 0)
			printf(&quot;the other side has been closed.\n&quot;);
		else
			Write(STDOUT_FILENO, buf, n);
	}

	Close(sockfd);
	return 0;
}</pre><p>&#x7F16;&#x8BD1;&#x5E76;&#x8FD0;&#x884C;server&#x548C;client&#xFF0C;&#x770B;&#x770B;&#x662F;&#x5426;&#x8FBE;&#x5230;&#x4E86;&#x4F60;&#x9884;&#x60F3;&#x7684;&#x7ED3;&#x679C;&#x3002; </p><pre class="screen">$ ./client
haha1
HAHA1 
haha2
the other side has been closed.
haha3
$</pre><p>&#x8FD9;&#x65F6;server&#x4ECD;&#x5728;&#x8FD0;&#x884C;&#xFF0C;&#x4F46;&#x662F;client&#x7684;&#x8FD0;&#x884C;&#x7ED3;&#x679C;&#x5E76;&#x4E0D;&#x6B63;&#x786E;&#x3002;&#x539F;&#x56E0;&#x662F;&#x4EC0;&#x4E48;&#x5462;&#xFF1F;&#x4ED4;&#x7EC6;&#x67E5;&#x770B;server.c&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#xFF0C;server&#x5BF9;&#x6BCF;&#x4E2A;&#x8BF7;&#x6C42;&#x53EA;&#x5904;&#x7406;&#x4E00;&#x6B21;&#xFF0C;&#x5E94;&#x7B54;&#x540E;&#x5C31;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#xFF0C;client&#x4E0D;&#x80FD;&#x7EE7;&#x7EED;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x8FDE;&#x63A5;&#x53D1;&#x9001;&#x6570;&#x636E;&#x3002;&#x4F46;&#x662F;client&#x4E0B;&#x6B21;&#x5FAA;&#x73AF;&#x65F6;&#x53C8;&#x8C03;&#x7528;write&#x53D1;&#x6570;&#x636E;&#x7ED9;server&#xFF0C;write&#x8C03;&#x7528;&#x53EA;&#x8D1F;&#x8D23;&#x628A;&#x6570;&#x636E;&#x4EA4;&#x7ED9;TCP&#x53D1;&#x9001;&#x7F13;&#x51B2;&#x533A;&#x5C31;&#x53EF;&#x4EE5;&#x6210;&#x529F;&#x8FD4;&#x56DE;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x4E0D;&#x4F1A;&#x51FA;&#x9519;&#xFF0C;&#x800C;server&#x6536;&#x5230;&#x6570;&#x636E;&#x540E;&#x5E94;&#x7B54;&#x4E00;&#x4E2A;RST&#x6BB5;&#xFF0C;client&#x6536;&#x5230;RST&#x6BB5;&#x540E;&#x65E0;&#x6CD5;&#x7ACB;&#x523B;&#x901A;&#x77E5;&#x5E94;&#x7528;&#x5C42;&#xFF0C;&#x53EA;&#x628A;&#x8FD9;&#x4E2A;&#x72B6;&#x6001;&#x4FDD;&#x5B58;&#x5728;TCP&#x534F;&#x8BAE;&#x5C42;&#x3002;client&#x4E0B;&#x6B21;&#x5FAA;&#x73AF;&#x53C8;&#x8C03;&#x7528;write&#x53D1;&#x6570;&#x636E;&#x7ED9;server&#xFF0C;&#x7531;&#x4E8E;TCP&#x534F;&#x8BAE;&#x5C42;&#x5DF2;&#x7ECF;&#x5904;&#x4E8E;RST&#x72B6;&#x6001;&#x4E86;&#xFF0C;&#x56E0;&#x6B64;&#x4E0D;&#x4F1A;&#x5C06;&#x6570;&#x636E;&#x53D1;&#x51FA;&#xFF0C;&#x800C;&#x662F;&#x53D1;&#x4E00;&#x4E2A;SIGPIPE&#x4FE1;&#x53F7;&#x7ED9;&#x5E94;&#x7528;&#x5C42;&#xFF0C;SIGPIPE&#x4FE1;&#x53F7;&#x7684;&#x7F3A;&#x7701;&#x5904;&#x7406;&#x52A8;&#x4F5C;&#x662F;&#x7EC8;&#x6B62;&#x7A0B;&#x5E8F;&#xFF0C;&#x6240;&#x4EE5;&#x770B;&#x5230;&#x4E0A;&#x9762;&#x7684;&#x73B0;&#x8C61;&#x3002;</p><p>&#x4E3A;&#x4E86;&#x907F;&#x514D;client&#x5F02;&#x5E38;&#x9000;&#x51FA;&#xFF0C;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x5E94;&#x8BE5;&#x5728;&#x5224;&#x65AD;&#x5BF9;&#x65B9;&#x5173;&#x95ED;&#x4E86;&#x8FDE;&#x63A5;&#x540E;break&#x51FA;&#x5FAA;&#x73AF;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x7EE7;&#x7EED;write&#x3002;&#x53E6;&#x5916;&#xFF0C;&#x6709;&#x65F6;&#x5019;&#x4EE3;&#x7801;&#x4E2D;&#x9700;&#x8981;&#x8FDE;&#x7EED;&#x591A;&#x6B21;&#x8C03;&#x7528;write&#xFF0C;&#x53EF;&#x80FD;&#x8FD8;&#x6765;&#x4E0D;&#x53CA;&#x8C03;&#x7528;read&#x5F97;&#x77E5;&#x5BF9;&#x65B9;&#x5DF2;&#x5173;&#x95ED;&#x4E86;&#x8FDE;&#x63A5;&#x5C31;&#x88AB;SIGPIPE&#x4FE1;&#x53F7;&#x7EC8;&#x6B62;&#x6389;&#x4E86;&#xFF0C;&#x8FD9;&#x5C31;&#x9700;&#x8981;&#x5728;&#x521D;&#x59CB;&#x5316;&#x65F6;&#x8C03;&#x7528;sigaction&#x5904;&#x7406;SIGPIPE&#x4FE1;&#x53F7;&#xFF0C;&#x5982;&#x679C;SIGPIPE&#x4FE1;&#x53F7;&#x6CA1;&#x6709;&#x5BFC;&#x81F4;&#x8FDB;&#x7A0B;&#x5F02;&#x5E38;&#x9000;&#x51FA;&#xFF0C;write&#x8FD4;&#x56DE;-1&#x5E76;&#x4E14;errno&#x4E3A;EPIPE&#x3002;</p><p>&#x53E6;&#x5916;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4FEE;&#x6539;server&#xFF0C;&#x4F7F;&#x5B83;&#x53EF;&#x4EE5;&#x591A;&#x6B21;&#x5904;&#x7406;&#x540C;&#x4E00;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8BF7;&#x6C42;&#x3002;</p><pre class="programlisting">/* server.c */
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;netinet/in.h&gt;
#include &quot;wrap.h&quot;

#define MAXLINE 80
#define SERV_PORT 8000

int main(void)
{
	struct sockaddr_in servaddr, cliaddr;
	socklen_t cliaddr_len;
	int listenfd, connfd;
	char buf[MAXLINE];
	char str[INET_ADDRSTRLEN];
	int i, n;

	listenfd = Socket(AF_INET, SOCK_STREAM, 0);

	bzero(&amp;servaddr, sizeof(servaddr));
	servaddr.sin_family = AF_INET;
	servaddr.sin_addr.s_addr = htonl(INADDR_ANY);
	servaddr.sin_port = htons(SERV_PORT);
    
	Bind(listenfd, (struct sockaddr *)&amp;servaddr, sizeof(servaddr));

	Listen(listenfd, 20);

	printf(&quot;Accepting connections ...\n&quot;);
	while (1) {
		cliaddr_len = sizeof(cliaddr);
		connfd = Accept(listenfd, 
				(struct sockaddr *)&amp;cliaddr, &amp;cliaddr_len);
		while (1) {
			n = Read(connfd, buf, MAXLINE);
			if (n == 0) {
				printf(&quot;the other side has been closed.\n&quot;);
				break;
			}
			printf(&quot;received from %s at PORT %d\n&quot;,
			       inet_ntop(AF_INET, &amp;cliaddr.sin_addr, str, sizeof(str)),
			       ntohs(cliaddr.sin_port));
    
			for (i = 0; i &lt; n; i++)
				buf[i] = toupper(buf[i]);
			Write(connfd, buf, n);
		}
		Close(connfd);
	}
}</pre><p>&#x7ECF;&#x8FC7;&#x4E0A;&#x9762;&#x7684;&#x4FEE;&#x6539;&#x540E;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x53EF;&#x4EE5;&#x8FDB;&#x884C;&#x591A;&#x6B21;&#x4EA4;&#x4E92;&#x4E86;&#x3002;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x901A;&#x5E38;&#x662F;&#x8981;&#x540C;&#x65F6;&#x670D;&#x52A1;&#x591A;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#xFF0C;&#x8FD0;&#x884C;&#x4E0A;&#x9762;&#x7684;server&#x548C;client&#x4E4B;&#x540E;&#xFF0C;&#x518D;&#x5F00;&#x4E00;&#x4E2A;&#x7EC8;&#x7AEF;&#x8FD0;&#x884C;client&#x8BD5;&#x8BD5;&#xFF0C;&#x65B0;&#x7684;client&#x80FD;&#x5F97;&#x5230;&#x670D;&#x52A1;&#x5417;&#xFF1F;&#x60F3;&#x60F3;&#x4E3A;&#x4EC0;&#x4E48;&#x3002;</p></div><div class="sect2" lang="zh-cn" xml:lang="zh-cn"><div class="titlepage"><div><div><h3 class="title"><a id="id2903959"></a>2.4.&#xA0;&#x4F7F;&#x7528;fork&#x5E76;&#x53D1;&#x5904;&#x7406;&#x591A;&#x4E2A;client&#x7684;&#x8BF7;&#x6C42;</h3></div></div></div><p>&#x600E;&#x4E48;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF1F;&#x7F51;&#x7EDC;&#x670D;&#x52A1;&#x5668;&#x901A;&#x5E38;&#x7528;fork&#x6765;&#x540C;&#x65F6;&#x670D;&#x52A1;&#x591A;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x7236;&#x8FDB;&#x7A0B;&#x4E13;&#x95E8;&#x8D1F;&#x8D23;&#x76D1;&#x542C;&#x7AEF;&#x53E3;&#xFF0C;&#x6BCF;&#x6B21;accept&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x8FDE;&#x63A5;&#x5C31;fork&#x51FA;&#x4E00;&#x4E2A;&#x5B50;&#x8FDB;&#x7A0B;&#x4E13;&#x95E8;&#x670D;&#x52A1;&#x8FD9;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x3002;&#x4F46;&#x662F;&#x5B50;&#x8FDB;&#x7A0B;&#x9000;&#x51FA;&#x65F6;&#x4F1A;&#x4EA7;&#x751F;&#x50F5;&#x5C38;&#x8FDB;&#x7A0B;&#xFF0C;&#x7236;&#x8FDB;&#x7A0B;&#x8981;&#x6CE8;&#x610F;&#x5904;&#x7406;SIGCHLD&#x4FE1;&#x53F7;&#x548C;&#x8C03;&#x7528;wait&#x6E05;&#x7406;&#x50F5;&#x5C38;&#x8FDB;&#x7A0B;&#x3002;</p><p>&#x4EE5;&#x4E0B;&#x7ED9;&#x51FA;&#x4EE3;&#x7801;&#x6846;&#x67B6;&#xFF0C;&#x5B8C;&#x6574;&#x7684;&#x4EE3;&#x7801;&#x8BF7;&#x8BFB;&#x8005;&#x81EA;&#x5DF1;&#x5B8C;&#x6210;&#x3002;</p><pre class="programlisting">listenfd = socket(...);
bind(listenfd, ...);
listen(listenfd, ...); 
while (1) {
	connfd = accept(listenfd, ...);
	n = fork();
	if (n == -1) {
		perror(&quot;call to fork&quot;);
		exit(1);
	} else if (n == 0) {
		close(listenfd);
		while (1) {
			read(connfd, ...);
			...
			write(connfd, ...);
		}
		close(connfd);
		exit(0);
	} else
		close(connfd);
}</pre></div><div class="sect2" lang="zh-cn" xml:lang="zh-cn"><div class="titlepage"><div><div><h3 class="title"><a id="id2904007"></a>2.5.&#xA0;setsockopt</h3></div></div></div><p>&#x73B0;&#x5728;&#x505A;&#x4E00;&#x4E2A;&#x6D4B;&#x8BD5;&#xFF0C;&#x9996;&#x5148;&#x542F;&#x52A8;server&#xFF0C;&#x7136;&#x540E;&#x542F;&#x52A8;client&#xFF0C;&#x7136;&#x540E;&#x7528;Ctrl-C&#x4F7F;server&#x7EC8;&#x6B62;&#xFF0C;&#x8FD9;&#x65F6;&#x9A6C;&#x4E0A;&#x518D;&#x8FD0;&#x884C;server&#xFF0C;&#x7ED3;&#x679C;&#x662F;&#xFF1A;</p><pre class="screen">$ ./server
 bind error: Address already in use</pre><p>&#x8FD9;&#x662F;&#x56E0;&#x4E3A;&#xFF0C;&#x867D;&#x7136;server&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7EC8;&#x6B62;&#x4E86;&#xFF0C;&#x4F46;TCP&#x534F;&#x8BAE;&#x5C42;&#x7684;&#x8FDE;&#x63A5;&#x5E76;&#x6CA1;&#x6709;&#x5B8C;&#x5168;&#x65AD;&#x5F00;&#xFF0C;&#x56E0;&#x6B64;&#x4E0D;&#x80FD;&#x518D;&#x6B21;&#x76D1;&#x542C;&#x540C;&#x6837;&#x7684;server&#x7AEF;&#x53E3;&#x3002;&#x6211;&#x4EEC;&#x7528;netstat&#x547D;&#x4EE4;&#x67E5;&#x770B;&#x4E00;&#x4E0B;&#xFF1A;</p><pre class="screen">$ netstat -apn |grep 8000
 tcp        1      0 127.0.0.1:33498         127.0.0.1:8000          CLOSE_WAIT 10830/client        
 tcp        0      0 127.0.0.1:8000          127.0.0.1:33498         FIN_WAIT2  -</pre><p>server&#x7EC8;&#x6B62;&#x65F6;&#xFF0C;socket&#x63CF;&#x8FF0;&#x7B26;&#x4F1A;&#x81EA;&#x52A8;&#x5173;&#x95ED;&#x5E76;&#x53D1;FIN&#x6BB5;&#x7ED9;client&#xFF0C;client&#x6536;&#x5230;FIN&#x540E;&#x5904;&#x4E8E;CLOSE_WAIT&#x72B6;&#x6001;&#xFF0C;&#x4F46;&#x662F;client&#x5E76;&#x6CA1;&#x6709;&#x7EC8;&#x6B62;&#xFF0C;&#x4E5F;&#x6CA1;&#x6709;&#x5173;&#x95ED;socket&#x63CF;&#x8FF0;&#x7B26;&#xFF0C;&#x56E0;&#x6B64;&#x4E0D;&#x4F1A;&#x53D1;FIN&#x7ED9;server&#xFF0C;&#x56E0;&#x6B64;server&#x7684;TCP&#x8FDE;&#x63A5;&#x5904;&#x4E8E;FIN_WAIT2&#x72B6;&#x6001;&#x3002;</p><p>&#x73B0;&#x5728;&#x7528;Ctrl-C&#x628A;client&#x4E5F;&#x7EC8;&#x6B62;&#x6389;&#xFF0C;&#x518D;&#x89C2;&#x5BDF;&#x73B0;&#x8C61;&#xFF1A;</p><pre class="screen">$ netstat -apn |grep 8000
 tcp        0      0 127.0.0.1:8000          127.0.0.1:44685         TIME_WAIT  -
 $ ./server
 bind error: Address already in use</pre><p>client&#x7EC8;&#x6B62;&#x65F6;&#x81EA;&#x52A8;&#x5173;&#x95ED;socket&#x63CF;&#x8FF0;&#x7B26;&#xFF0C;server&#x7684;TCP&#x8FDE;&#x63A5;&#x6536;&#x5230;client&#x53D1;&#x7684;FIN&#x6BB5;&#x540E;&#x5904;&#x4E8E;TIME_WAIT&#x72B6;&#x6001;&#x3002;TCP&#x534F;&#x8BAE;&#x89C4;&#x5B9A;&#xFF0C;&#x4E3B;&#x52A8;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#x7684;&#x4E00;&#x65B9;&#x8981;&#x5904;&#x4E8E;TIME_WAIT&#x72B6;&#x6001;&#xFF0C;&#x7B49;&#x5F85;&#x4E24;&#x4E2A;MSL&#xFF08;maximum segment lifetime&#xFF09;&#x7684;&#x65F6;&#x95F4;&#x540E;&#x624D;&#x80FD;&#x56DE;&#x5230;CLOSED&#x72B6;&#x6001;&#xFF0C;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x5148;Ctrl-C&#x7EC8;&#x6B62;&#x4E86;server&#xFF0C;&#x6240;&#x4EE5;server&#x662F;&#x4E3B;&#x52A8;&#x5173;&#x95ED;&#x8FDE;&#x63A5;&#x7684;&#x4E00;&#x65B9;&#xFF0C;&#x5728;TIME_WAIT&#x671F;&#x95F4;&#x4ECD;&#x7136;&#x4E0D;&#x80FD;&#x518D;&#x6B21;&#x76D1;&#x542C;&#x540C;&#x6837;&#x7684;server&#x7AEF;&#x53E3;&#x3002;MSL&#x5728;RFC1122&#x4E2D;&#x89C4;&#x5B9A;&#x4E3A;&#x4E24;&#x5206;&#x949F;&#xFF0C;&#x4F46;&#x662F;&#x5404;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7684;&#x5B9E;&#x73B0;&#x4E0D;&#x540C;&#xFF0C;&#x5728;Linux&#x4E0A;&#x4E00;&#x822C;&#x7ECF;&#x8FC7;&#x534A;&#x5206;&#x949F;&#x540E;&#x5C31;&#x53EF;&#x4EE5;&#x518D;&#x6B21;&#x542F;&#x52A8;server&#x4E86;&#x3002;&#x81F3;&#x4E8E;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x89C4;&#x5B9A;TIME_WAIT&#x7684;&#x65F6;&#x95F4;&#x8BF7;&#x8BFB;&#x8005;&#x53C2;&#x8003;UNP 2.7&#x8282;&#x3002;</p><p>&#x5728;server&#x7684;TCP&#x8FDE;&#x63A5;&#x6CA1;&#x6709;&#x5B8C;&#x5168;&#x65AD;&#x5F00;&#x4E4B;&#x524D;&#x4E0D;&#x5141;&#x8BB8;&#x91CD;&#x65B0;&#x76D1;&#x542C;&#x662F;&#x4E0D;&#x5408;&#x7406;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#xFF0C;TCP&#x8FDE;&#x63A5;&#x6CA1;&#x6709;&#x5B8C;&#x5168;&#x65AD;&#x5F00;&#x6307;&#x7684;&#x662F;connfd&#xFF08;127.0.0.1:8000&#xFF09;&#x6CA1;&#x6709;&#x5B8C;&#x5168;&#x65AD;&#x5F00;&#xFF0C;&#x800C;&#x6211;&#x4EEC;&#x91CD;&#x65B0;&#x76D1;&#x542C;&#x7684;&#x662F;listenfd&#xFF08;0.0.0.0:8000&#xFF09;&#xFF0C;&#x867D;&#x7136;&#x662F;&#x5360;&#x7528;&#x540C;&#x4E00;&#x4E2A;&#x7AEF;&#x53E3;&#xFF0C;&#x4F46;IP&#x5730;&#x5740;&#x4E0D;&#x540C;&#xFF0C;connfd&#x5BF9;&#x5E94;&#x7684;&#x662F;&#x4E0E;&#x67D0;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x901A;&#x8BAF;&#x7684;&#x4E00;&#x4E2A;&#x5177;&#x4F53;&#x7684;IP&#x5730;&#x5740;&#xFF0C;&#x800C;listenfd&#x5BF9;&#x5E94;&#x7684;&#x662F;wildcard address&#x3002;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x7684;&#x65B9;&#x6CD5;&#x662F;&#x4F7F;&#x7528;setsockopt()&#x8BBE;&#x7F6E;socket&#x63CF;&#x8FF0;&#x7B26;&#x7684;&#x9009;&#x9879;SO_REUSEADDR&#x4E3A;1&#xFF0C;&#x8868;&#x793A;&#x5141;&#x8BB8;&#x521B;&#x5EFA;&#x7AEF;&#x53E3;&#x53F7;&#x76F8;&#x540C;&#x4F46;IP&#x5730;&#x5740;&#x4E0D;&#x540C;&#x7684;&#x591A;&#x4E2A;socket&#x63CF;&#x8FF0;&#x7B26;&#x3002;&#x5728;server&#x4EE3;&#x7801;&#x7684;socket()&#x548C;bind()&#x8C03;&#x7528;&#x4E4B;&#x95F4;&#x63D2;&#x5165;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#xFF1A;</p><pre class="programlisting">int opt = 1;
setsockopt(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;opt, sizeof(opt));</pre><p>&#x6709;&#x5173;setsockopt&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;&#x7684;&#x5176;&#x5B83;&#x9009;&#x9879;&#x8BF7;&#x53C2;&#x8003;UNP&#x7B2C;7&#x7AE0;&#x3002;</p></div><div class="sect2" lang="zh-cn" xml:lang="zh-cn"><div class="titlepage"><div><div><h3 class="title"><a id="id2904122"></a>2.6.&#xA0;&#x4F7F;&#x7528;select</h3></div></div></div><p>select&#x662F;&#x7F51;&#x7EDC;&#x7A0B;&#x5E8F;&#x4E2D;&#x5F88;&#x5E38;&#x7528;&#x7684;&#x4E00;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x540C;&#x65F6;&#x76D1;&#x542C;&#x591A;&#x4E2A;&#x963B;&#x585E;&#x7684;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#xFF08;&#x4F8B;&#x5982;&#x591A;&#x4E2A;&#x7F51;&#x7EDC;&#x8FDE;&#x63A5;&#xFF09;&#xFF0C;&#x54EA;&#x4E2A;&#x6709;&#x6570;&#x636E;&#x5230;&#x8FBE;&#x5C31;&#x5904;&#x7406;&#x54EA;&#x4E2A;&#xFF0C;&#x8FD9;&#x6837;&#xFF0C;&#x4E0D;&#x9700;&#x8981;fork&#x548C;&#x591A;&#x8FDB;&#x7A0B;&#x5C31;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x5E76;&#x53D1;&#x670D;&#x52A1;&#x7684;server&#x3002;</p><pre class="programlisting">/* server.c */
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;netinet/in.h&gt;
#include &quot;wrap.h&quot;

#define MAXLINE 80
#define SERV_PORT 8000

int main(int argc, char **argv)
{
	int i, maxi, maxfd, listenfd, connfd, sockfd;
	int nready, client[FD_SETSIZE];
	ssize_t n;
	fd_set rset, allset;
	char buf[MAXLINE];
	char str[INET_ADDRSTRLEN];
	socklen_t cliaddr_len;
	struct sockaddr_in	cliaddr, servaddr;

	listenfd = Socket(AF_INET, SOCK_STREAM, 0);

	bzero(&amp;servaddr, sizeof(servaddr));
	servaddr.sin_family      = AF_INET;
	servaddr.sin_addr.s_addr = htonl(INADDR_ANY);
	servaddr.sin_port        = htons(SERV_PORT);

	Bind(listenfd, (struct sockaddr *)&amp;servaddr, sizeof(servaddr));

	Listen(listenfd, 20);

	maxfd = listenfd;		/* initialize */
	maxi = -1;			/* index into client[] array */
	for (i = 0; i &lt; FD_SETSIZE; i++)
		client[i] = -1;	/* -1 indicates available entry */
	FD_ZERO(&amp;allset);
	FD_SET(listenfd, &amp;allset);

	for ( ; ; ) {
		rset = allset;	/* structure assignment */
		nready = select(maxfd+1, &amp;rset, NULL, NULL, NULL);
		if (nready &lt; 0)
			perr_exit(&quot;select error&quot;);

		if (FD_ISSET(listenfd, &amp;rset)) { /* new client connection */
			cliaddr_len = sizeof(cliaddr);
			connfd = Accept(listenfd, (struct sockaddr *)&amp;cliaddr, &amp;cliaddr_len);

			printf(&quot;received from %s at PORT %d\n&quot;,
			       inet_ntop(AF_INET, &amp;cliaddr.sin_addr, str, sizeof(str)),
			       ntohs(cliaddr.sin_port));

			for (i = 0; i &lt; FD_SETSIZE; i++)
				if (client[i] &lt; 0) {
					client[i] = connfd; /* save descriptor */
					break;
				}
			if (i == FD_SETSIZE) {
				fputs(&quot;too many clients\n&quot;, stderr);
				exit(1);
			}

			FD_SET(connfd, &amp;allset);	/* add new descriptor to set */
			if (connfd &gt; maxfd)
				maxfd = connfd; /* for select */
			if (i &gt; maxi)
				maxi = i;	/* max index in client[] array */

			if (--nready == 0)
				continue;	/* no more readable descriptors */
		}

		for (i = 0; i &lt;= maxi; i++) {	/* check all clients for data */
			if ( (sockfd = client[i]) &lt; 0)
				continue;
			if (FD_ISSET(sockfd, &amp;rset)) {
				if ( (n = Read(sockfd, buf, MAXLINE)) == 0) {
					/* connection closed by client */
					Close(sockfd);
					FD_CLR(sockfd, &amp;allset);
					client[i] = -1;
				} else {
					int j;
					for (j = 0; j &lt; n; j++)
						buf[j] = toupper(buf[j]);
					Write(sockfd, buf, n);
				}

				if (--nready == 0)
					break;	/* no more readable descriptors */
			}
		}
	}
}</pre></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tbody><tr><td width="40%" align="left"><a accesskey="p" href="ch37s01.html">&#x4E0A;&#x4E00;&#x9875;</a>&#xA0;</td><td width="20%" align="center"><a accesskey="u" href="ch37.html">&#x4E0A;&#x4E00;&#x7EA7;</a></td><td width="40%" align="right">&#xA0;<a accesskey="n" href="ch37s03.html">&#x4E0B;&#x4E00;&#x9875;</a></td></tr><tr><td width="40%" align="left" valign="top">1.&#xA0;&#x9884;&#x5907;&#x77E5;&#x8BC6;&#xA0;</td><td width="20%" align="center"><a accesskey="h" href="index.html">&#x8D77;&#x59CB;&#x9875;</a></td><td width="40%" align="right" valign="top">&#xA0;3.&#xA0;&#x57FA;&#x4E8E;UDP&#x534F;&#x8BAE;&#x7684;&#x7F51;&#x7EDC;&#x7A0B;&#x5E8F;</td></tr></tbody></table></div>
</body></html>